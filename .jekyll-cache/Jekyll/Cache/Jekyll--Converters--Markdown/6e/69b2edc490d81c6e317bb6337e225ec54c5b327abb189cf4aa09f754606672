I"*˜<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<blockquote>
  <p>æ•°æ®ç»‘å®šåº“æ˜¯ä¸€ç§æ”¯æŒåº“ï¼Œå€ŸåŠ©è¯¥åº“ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å£°æ˜æ€§æ ¼å¼ï¼ˆè€Œéç¨‹åºåŒ–åœ°ï¼‰å°†å¸ƒå±€ä¸­çš„ç•Œé¢ç»„ä»¶ç»‘å®šåˆ°åº”ç”¨ä¸­çš„æ•°æ®æºã€‚</p>
</blockquote>

<p>å¸ƒå±€é€šå¸¸æ˜¯ä½¿ç”¨è°ƒç”¨ç•Œé¢æ¡†æ¶æ–¹æ³•çš„ä»£ç åœ¨ Activity ä¸­å®šä¹‰çš„ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç è°ƒç”¨ findViewById() æ¥æŸ¥æ‰¾ TextView å¾®ä»¶å¹¶å°†å…¶ç»‘å®šåˆ° viewModel å˜é‡çš„ userName å±æ€§ï¼š</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">findViewById</span><span class="p">&lt;</span><span class="nc">TextView</span><span class="p">&gt;(</span><span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">sample_text</span><span class="p">).</span><span class="nf">apply</span> <span class="p">{</span>
    <span class="n">text</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">userName</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨å¸ƒå±€æ–‡ä»¶ä¸­ä½¿ç”¨æ•°æ®ç»‘å®šåº“å°†æ–‡æœ¬ç›´æ¥åˆ†é…åˆ°å¾®ä»¶ã€‚è¿™æ ·å°±æ— éœ€è°ƒç”¨ä¸Šè¿°ä»»ä½• Java ä»£ç ã€‚è¯·æ³¨æ„èµ‹å€¼è¡¨è¾¾å¼ä¸­ @{} è¯­æ³•çš„ä½¿ç”¨ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;TextView</span> <span class="na">android:text=</span><span class="s">"@{viewmodel.userName}"</span> <span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h1 id="gradleé…ç½®">gradleé…ç½®</h1>

<div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre> <span class="n">defaultConfig</span> <span class="o">{</span>
    <span class="o">....</span>
    <span class="n">dataBinding</span> <span class="o">{</span>
        <span class="n">enabled</span> <span class="kc">true</span>
    <span class="o">}</span>
 <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h1>

<ol>
  <li>å®šä¹‰å®ä½“å¯¹è±¡</li>
</ol>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">:</span> <span class="nc">BaseObservable</span><span class="p">()</span> <span class="p">{</span>

    <span class="nd">@Bindable</span>
    <span class="kd">var</span> <span class="py">name</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="n">name</span>
        <span class="k">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">field</span> <span class="p">=</span> <span class="n">value</span>
            <span class="nf">notifyPropertyChanged</span><span class="p">(</span><span class="nc">BR</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">}</span>


    <span class="nd">@Bindable</span>
    <span class="kd">var</span> <span class="py">age</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="n">age</span>
        <span class="k">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">field</span> <span class="p">=</span> <span class="n">value</span>
            <span class="nf">notifyPropertyChanged</span><span class="p">(</span><span class="nc">BR</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ol>
  <li>å¸ƒå±€æ–‡ä»¶ä¸­ä½¿ç”¨
activity_main.xml
æ ¹èŠ‚ç‚¹ç”¨layoutå…ƒç´ ï¼Œå¹¶æ·»åŠ dataèŠ‚ç‚¹ï¼Œå£°æ˜è¦ä½¿ç”¨çš„å®ä½“å¯¹è±¡
```xml
&lt;?xml version=â€1.0â€ encoding=â€utf-8â€?&gt;</li>
</ol>
<layout xmlns:android="http://schemas.android.com/apk/res/android" xmlns:app="http://schemas.android.com/apk/res-auto" xmlns:tools="http://schemas.android.com/tools">

    <data>

        <variable name="user" type="com.zhy.databinding.User" />
    </data>

    <androidx.constraintlayout.widget.ConstraintLayout android:layout_width="match_parent" android:layout_height="match_parent" tools:context=".MainActivity">

        <TextView android:id="@+id/tv_name" android:layout_width="wrap_content" android:layout_height="wrap_content" android:text="@{user.name}" app:layout_constraintBottom_toTopOf="@+id/tv_age" app:layout_constraintLeft_toLeftOf="parent" app:layout_constraintRight_toRightOf="parent" app:layout_constraintTop_toTopOf="parent" app:layout_constraintVertical_chainStyle="packed" />


        <TextView android:id="@+id/tv_age" android:layout_width="wrap_content" android:layout_height="wrap_content" android:text="@{String.valueOf(user.age)}" app:layout_constraintBottom_toBottomOf="parent" app:layout_constraintLeft_toLeftOf="parent" app:layout_constraintRight_toRightOf="parent" app:layout_constraintTop_toBottomOf="@+id/tv_name" />

        <button android:id="@+id/btn" android:layout_width="wrap_content" android:layout_height="wrap_content" app:layout_constraintend_toendof="parent" app:layout_constraintstart_tostartof="parent" app:layout_constrainttop_tobottomof="@+id/tv_age" android:text="ç‚¹å‡»æµ‹è¯•" />

        <button android:layout_margintop="10dp" android:id="@+id/btn2" android:layout_width="wrap_content" android:layout_height="wrap_content" app:layout_constraintend_toendof="parent" app:layout_constraintstart_tostartof="parent" app:layout_constrainttop_tobottomof="@+id/btn" android:text="å•ä¸ªå±æ€§å˜åŒ–" />
    </androidx.constraintlayout.widget.ConstraintLayout>
</layout>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>3. ä»£ç ä¸­ä½¿ç”¨
```kotlin
class MainActivity : AppCompatActivity() {

    private var age: Int = 18
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val binding: ActivityMainBinding = DataBindingUtil.setContentView(
            this, R.layout.activity_main
        )
        var user = User("å¼ ä¸‰", age++)
        binding.user = user

        binding.btn.setOnClickListener {
            //å¯¹è±¡æ”¹å˜
            user = User("å¼ ä¸‰", age++)
            binding.user = user
        }

        binding.btn2.setOnClickListener {
            //å¯¹è±¡å±æ€§æ”¹å˜
            age++
            user.age = age
            user.name = "å¼ ä¸‰$age"
        }
    }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="æ ¸å¿ƒåŸç†">æ ¸å¿ƒåŸç†</h1>

<h2 id="12-layout-å¸ƒå±€æ–‡ä»¶åˆ†ç¦»">1.2 layout å¸ƒå±€æ–‡ä»¶åˆ†ç¦»</h2>

<p>ç¼–è¯‘æ—¶ä¼šæ ¹æ®activity_main.xmlç”Ÿæˆä¸¤ä»½xmlæ–‡ä»¶</p>
<ul>
  <li>build/intermediates/data_binding_layout_info_type_merge/debug/out/activity_main-layout.xml</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8" standalone="yes"?&gt;</span>
<span class="nt">&lt;Layout</span> <span class="na">directory=</span><span class="s">"layout"</span> <span class="na">filePath=</span><span class="s">"app/src/main/res/layout/activity_main.xml"</span> <span class="na">isBindingData=</span><span class="s">"true"</span> <span class="na">isMerge=</span><span class="s">"false"</span> <span class="na">layout=</span><span class="s">"activity_main"</span> <span class="na">modulePackage=</span><span class="s">"com.zhy.databinding"</span> <span class="na">rootNodeType=</span><span class="s">"androidx.constraintlayout.widget.ConstraintLayout"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;Variables</span> <span class="na">declared=</span><span class="s">"true"</span> <span class="na">name=</span><span class="s">"user"</span> <span class="na">type=</span><span class="s">"com.zhy.databinding.User"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;location</span> <span class="na">endLine=</span><span class="s">"9"</span> <span class="na">endOffset=</span><span class="s">"45"</span> <span class="na">startLine=</span><span class="s">"7"</span> <span class="na">startOffset=</span><span class="s">"8"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/Variables&gt;</span>
	<span class="nt">&lt;Targets&gt;</span>
		<span class="nt">&lt;Target</span> <span class="na">tag=</span><span class="s">"layout/activity_main_0"</span> <span class="na">view=</span><span class="s">"androidx.constraintlayout.widget.ConstraintLayout"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;Expressions/&gt;</span>
			<span class="nt">&lt;location</span> <span class="na">endLine=</span><span class="s">"59"</span> <span class="na">endOffset=</span><span class="s">"55"</span> <span class="na">startLine=</span><span class="s">"12"</span> <span class="na">startOffset=</span><span class="s">"4"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;/Target&gt;</span>
		<span class="nt">&lt;Target</span> <span class="na">id=</span><span class="s">"@+id/tv_name"</span> <span class="na">tag=</span><span class="s">"binding_1"</span> <span class="na">view=</span><span class="s">"TextView"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;Expressions&gt;</span>
				<span class="nt">&lt;Expression</span> <span class="na">attribute=</span><span class="s">"android:text"</span> <span class="na">text=</span><span class="s">"user.name"</span><span class="nt">&gt;</span>
					<span class="nt">&lt;Location</span> <span class="na">endLine=</span><span class="s">"21"</span> <span class="na">endOffset=</span><span class="s">"38"</span> <span class="na">startLine=</span><span class="s">"21"</span> <span class="na">startOffset=</span><span class="s">"12"</span><span class="nt">/&gt;</span>
					<span class="nt">&lt;TwoWay&gt;</span>false<span class="nt">&lt;/TwoWay&gt;</span>
					<span class="nt">&lt;ValueLocation</span> <span class="na">endLine=</span><span class="s">"21"</span> <span class="na">endOffset=</span><span class="s">"36"</span> <span class="na">startLine=</span><span class="s">"21"</span> <span class="na">startOffset=</span><span class="s">"28"</span><span class="nt">/&gt;</span>
				<span class="nt">&lt;/Expression&gt;</span>
			<span class="nt">&lt;/Expressions&gt;</span>
			<span class="nt">&lt;location</span> <span class="na">endLine=</span><span class="s">"26"</span> <span class="na">endOffset=</span><span class="s">"63"</span> <span class="na">startLine=</span><span class="s">"17"</span> <span class="na">startOffset=</span><span class="s">"8"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;/Target&gt;</span>
		<span class="nt">&lt;Target</span> <span class="na">id=</span><span class="s">"@+id/tv_age"</span> <span class="na">tag=</span><span class="s">"binding_2"</span> <span class="na">view=</span><span class="s">"TextView"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;Expressions&gt;</span>
				<span class="nt">&lt;Expression</span> <span class="na">attribute=</span><span class="s">"android:text"</span> <span class="na">text=</span><span class="s">"String.valueOf(user.age)"</span><span class="nt">&gt;</span>
					<span class="nt">&lt;Location</span> <span class="na">endLine=</span><span class="s">"33"</span> <span class="na">endOffset=</span><span class="s">"53"</span> <span class="na">startLine=</span><span class="s">"33"</span> <span class="na">startOffset=</span><span class="s">"12"</span><span class="nt">/&gt;</span>
					<span class="nt">&lt;TwoWay&gt;</span>false<span class="nt">&lt;/TwoWay&gt;</span>
					<span class="nt">&lt;ValueLocation</span> <span class="na">endLine=</span><span class="s">"33"</span> <span class="na">endOffset=</span><span class="s">"51"</span> <span class="na">startLine=</span><span class="s">"33"</span> <span class="na">startOffset=</span><span class="s">"28"</span><span class="nt">/&gt;</span>
				<span class="nt">&lt;/Expression&gt;</span>
			<span class="nt">&lt;/Expressions&gt;</span>
			<span class="nt">&lt;location</span> <span class="na">endLine=</span><span class="s">"37"</span> <span class="na">endOffset=</span><span class="s">"64"</span> <span class="na">startLine=</span><span class="s">"29"</span> <span class="na">startOffset=</span><span class="s">"8"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;/Target&gt;</span>
		<span class="nt">&lt;Target</span> <span class="na">id=</span><span class="s">"@+id/btn"</span> <span class="na">view=</span><span class="s">"Button"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;Expressions/&gt;</span>
			<span class="nt">&lt;location</span> <span class="na">endLine=</span><span class="s">"47"</span> <span class="na">endOffset=</span><span class="s">"13"</span> <span class="na">startLine=</span><span class="s">"39"</span> <span class="na">startOffset=</span><span class="s">"8"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;/Target&gt;</span>
		<span class="nt">&lt;Target</span> <span class="na">id=</span><span class="s">"@+id/btn2"</span> <span class="na">view=</span><span class="s">"Button"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;Expressions/&gt;</span>
			<span class="nt">&lt;location</span> <span class="na">endLine=</span><span class="s">"58"</span> <span class="na">endOffset=</span><span class="s">"13"</span> <span class="na">startLine=</span><span class="s">"49"</span> <span class="na">startOffset=</span><span class="s">"8"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;/Target&gt;</span>
	<span class="nt">&lt;/Targets&gt;</span>
<span class="nt">&lt;/Layout&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ¯ä¸ªViewéƒ½å¯¹åº”ä¸€ä¸ªTargetå…ƒç´ ï¼ŒTargetè®°å½•äº†viewçš„id,tag,ä»¥åŠä½¿ç”¨çš„è¡¨è¾¾å¼(ä½¿ç”¨@{})ç­‰ç­‰ä¿¡æ¯</p>

<ul>
  <li>build/intermediates/incremental/mergeDebugResources/stripped.dir/layout/activity_main.xml</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>

                                                       
                                                   

    

                 
                       
                                              
           

    <span class="nt">&lt;androidx.constraintlayout.widget.ConstraintLayout</span>
        <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
        <span class="na">android:layout_height=</span><span class="s">"match_parent"</span>
        <span class="na">tools:context=</span><span class="s">".MainActivity"</span> <span class="na">android:tag=</span><span class="s">"layout/activity_main_0"</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span> <span class="na">xmlns:app=</span><span class="s">"http://schemas.android.com/apk/res-auto"</span> <span class="na">xmlns:tools=</span><span class="s">"http://schemas.android.com/tools"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">"@+id/tv_name"</span>
            <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
            <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span>
            <span class="na">android:tag=</span><span class="s">"binding_1"</span>    
            <span class="na">app:layout_constraintBottom_toTopOf=</span><span class="s">"@+id/tv_age"</span>
            <span class="na">app:layout_constraintLeft_toLeftOf=</span><span class="s">"parent"</span>
            <span class="na">app:layout_constraintRight_toRightOf=</span><span class="s">"parent"</span>
            <span class="na">app:layout_constraintTop_toTopOf=</span><span class="s">"parent"</span>
            <span class="na">app:layout_constraintVertical_chainStyle=</span><span class="s">"packed"</span> <span class="nt">/&gt;</span>


        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">"@+id/tv_age"</span>
            <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
            <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span>
            <span class="na">android:tag=</span><span class="s">"binding_2"</span>                   
            <span class="na">app:layout_constraintBottom_toBottomOf=</span><span class="s">"parent"</span>
            <span class="na">app:layout_constraintLeft_toLeftOf=</span><span class="s">"parent"</span>
            <span class="na">app:layout_constraintRight_toRightOf=</span><span class="s">"parent"</span>
            <span class="na">app:layout_constraintTop_toBottomOf=</span><span class="s">"@+id/tv_name"</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;Button</span>
            <span class="na">android:id=</span><span class="s">"@+id/btn"</span>
            <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
            <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span>
            <span class="na">app:layout_constraintEnd_toEndOf=</span><span class="s">"parent"</span>
            <span class="na">app:layout_constraintStart_toStartOf=</span><span class="s">"parent"</span>
            <span class="na">app:layout_constraintTop_toBottomOf=</span><span class="s">"@+id/tv_age"</span>
            <span class="na">android:text=</span><span class="s">"ç‚¹å‡»æµ‹è¯•"</span>
            <span class="nt">/&gt;</span>

        <span class="nt">&lt;Button</span>
            <span class="na">android:layout_marginTop=</span><span class="s">"10dp"</span>
            <span class="na">android:id=</span><span class="s">"@+id/btn2"</span>
            <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
            <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span>
            <span class="na">app:layout_constraintEnd_toEndOf=</span><span class="s">"parent"</span>
            <span class="na">app:layout_constraintStart_toStartOf=</span><span class="s">"parent"</span>
            <span class="na">app:layout_constraintTop_toBottomOf=</span><span class="s">"@+id/btn"</span>
            <span class="na">android:text=</span><span class="s">"å•ä¸ªå±æ€§å˜åŒ–"</span>
            <span class="nt">/&gt;</span>
    <span class="nt">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™ä¸ªxmlä¼šå‰”é™¤æ‰layoutèŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¸ºç»‘å®šäº†@{}çš„Viewæ·»åŠ ä¸€ä¸ªtag</p>

<h2 id="æºç åˆ†æ">æºç åˆ†æ</h2>

<p>é¦–å…ˆçœ‹aptç”Ÿæˆçš„ç±»</p>

<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/6468c19fcab299cfcda2f3847e95aeab-89883" alt="6468c19fcab299cfcda2f3847e95aeab.png" /></p>

<p>ç±»å›¾å¦‚ä¸‹:</p>

<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/297aa8265830b304536747f02a8a95c7-38316" alt="297aa8265830b304536747f02a8a95c7.png" /></p>

<h3 id="å…¥å£1-databindingutilsetcontentview">å…¥å£1ï¼š DataBindingUtil.setContentView</h3>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">//DataBindingUtil.java</span>
<span class="k">public</span> <span class="n">static</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="n">extends</span> <span class="nc">ViewDataBinding</span><span class="p">&gt;</span> <span class="nc">T</span> <span class="nf">setContentView</span><span class="p">(</span><span class="nd">@NonNull</span> <span class="nc">Activity</span> <span class="n">activity</span><span class="p">,</span>
        <span class="n">int</span> <span class="n">layoutId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">setContentView</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">layoutId</span><span class="p">,</span> <span class="n">sDefaultComponent</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>setContentViewæ–¹æ³•é‡è½½ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">ViewDataBinding</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">setContentView</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Activity</span> <span class="n">activity</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">layoutId</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">DataBindingComponent</span> <span class="n">bindingComponent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">activity</span><span class="o">.</span><span class="na">setContentView</span><span class="o">(</span><span class="n">layoutId</span><span class="o">);</span>
    <span class="nc">View</span> <span class="n">decorView</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="na">getWindow</span><span class="o">().</span><span class="na">getDecorView</span><span class="o">();</span>
    <span class="nc">ViewGroup</span> <span class="n">contentView</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ViewGroup</span><span class="o">)</span> <span class="n">decorView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">content</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">bindToAddedViews</span><span class="o">(</span><span class="n">bindingComponent</span><span class="o">,</span> <span class="n">contentView</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">layoutId</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä»è¿™ä¸ªæ–¹æ³•å¯ä»¥çœ‹å‡ºactivityå’Œxmlè¿˜æ˜¯é€šè¿‡setContentView(layoutId)æ¥è¿›è¡Œå…³è”çš„ï¼Œ</p>

<p>å†çœ‹bindToAddedViewsæ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">ViewDataBinding</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">bindToAddedViews</span><span class="o">(</span><span class="nc">DataBindingComponent</span> <span class="n">component</span><span class="o">,</span>
        <span class="nc">ViewGroup</span> <span class="n">parent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startChildren</span><span class="o">,</span> <span class="kt">int</span> <span class="n">layoutId</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">endChildren</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">getChildCount</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">childrenAdded</span> <span class="o">=</span> <span class="n">endChildren</span> <span class="o">-</span> <span class="n">startChildren</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">childrenAdded</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">View</span> <span class="n">childView</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">getChildAt</span><span class="o">(</span><span class="n">endChildren</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">bind</span><span class="o">(</span><span class="n">component</span><span class="o">,</span> <span class="n">childView</span><span class="o">,</span> <span class="n">layoutId</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">View</span><span class="o">[]</span> <span class="n">children</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">View</span><span class="o">[</span><span class="n">childrenAdded</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">childrenAdded</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">children</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">getChildAt</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">startChildren</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">bind</span><span class="o">(</span><span class="n">component</span><span class="o">,</span> <span class="n">children</span><span class="o">,</span> <span class="n">layoutId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">ViewDataBinding</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">bind</span><span class="o">(</span><span class="nc">DataBindingComponent</span> <span class="n">bindingComponent</span><span class="o">,</span> <span class="nc">View</span><span class="o">[]</span> <span class="n">roots</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">layoutId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">sMapper</span><span class="o">.</span><span class="na">getDataBinder</span><span class="o">(</span><span class="n">bindingComponent</span><span class="o">,</span> <span class="n">roots</span><span class="o">,</span> <span class="n">layoutId</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ€ç»ˆè°ƒç”¨åˆ°sMapper.getDataBinderï¼ŒsMapperåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="nc">DataBinderMapper</span> <span class="n">sMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataBinderMapperImpl</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ€åçš„æœ€åä¼šè°ƒåˆ°DataBinderMapperImplçš„getDataBinderæ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1">//MergedDataBinderMapper.java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">ViewDataBinding</span> <span class="nf">getDataBinder</span><span class="o">(</span><span class="nc">DataBindingComponent</span> <span class="n">bindingComponent</span><span class="o">,</span> <span class="nc">View</span><span class="o">[]</span> <span class="n">view</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">layoutId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">DataBinderMapper</span> <span class="n">mapper</span> <span class="o">:</span> <span class="n">mMappers</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ViewDataBinding</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">getDataBinder</span><span class="o">(</span><span class="n">bindingComponent</span><span class="o">,</span> <span class="n">view</span><span class="o">,</span> <span class="n">layoutId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">loadFeatures</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getDataBinder</span><span class="o">(</span><span class="n">bindingComponent</span><span class="o">,</span> <span class="n">view</span><span class="o">,</span> <span class="n">layoutId</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>DataBinderMapperImplçš„æ„é€ æ–¹æ³•ä¸­æŠŠaptç”Ÿæˆçš„com.zhy.databinding.DataBinderMapperImplç±»æ·»åŠ åˆ°mMapperé›†åˆä¸­</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1">//androidx.databinding.DataBinderMapperImpl.java</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataBinderMapperImpl</span> <span class="kd">extends</span> <span class="nc">MergedDataBinderMapper</span> <span class="o">{</span>
  <span class="nc">DataBinderMapperImpl</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">addMapper</span><span class="o">(</span><span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">zhy</span><span class="o">.</span><span class="na">databinding</span><span class="o">.</span><span class="na">DataBinderMapperImpl</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ€ç»ˆè°ƒç”¨çš„æ˜¯com.zhy.databinding.DataBinderMapperImpl.getDataBinder()æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataBinderMapperImpl</span> <span class="kd">extends</span> <span class="nc">DataBinderMapper</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">LAYOUT_ACTIVITYMAIN</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">SparseIntArray</span> <span class="no">INTERNAL_LAYOUT_ID_LOOKUP</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SparseIntArray</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

  <span class="kd">static</span> <span class="o">{</span>
    <span class="no">INTERNAL_LAYOUT_ID_LOOKUP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">zhy</span><span class="o">.</span><span class="na">databinding</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">,</span> <span class="no">LAYOUT_ACTIVITYMAIN</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">ViewDataBinding</span> <span class="nf">getDataBinder</span><span class="o">(</span><span class="nc">DataBindingComponent</span> <span class="n">component</span><span class="o">,</span> <span class="nc">View</span> <span class="n">view</span><span class="o">,</span> <span class="kt">int</span> <span class="n">layoutId</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">localizedLayoutId</span> <span class="o">=</span> <span class="no">INTERNAL_LAYOUT_ID_LOOKUP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">layoutId</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">localizedLayoutId</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="nc">Object</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="na">getTag</span><span class="o">();</span>
      <span class="k">if</span><span class="o">(</span><span class="n">tag</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"view must have a tag"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">switch</span><span class="o">(</span><span class="n">localizedLayoutId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span>  <span class="nl">LAYOUT_ACTIVITYMAIN:</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="s">"layout/activity_main_0"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">tag</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">ActivityMainBindingImpl</span><span class="o">(</span><span class="n">component</span><span class="o">,</span> <span class="n">view</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"The tag for activity_main is invalid. Received: "</span> <span class="o">+</span> <span class="n">tag</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">//......</span>
<span class="o">}</span>  
</pre></td></tr></tbody></table></code></pre></div></div>

<p>build/intermediates/incremental/mergeDebugResources/stripped.dir/layout/activity_main.xmlè¿™ä¸ªæ–‡ä»¶ä¸­æ‰¾åˆ°tagä¸ºlayout/activity_main_0çš„View -&gt;ConstraintLayout,æœ€åè¿”å› ActivityMainBindingImpl(component, view)</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>  <span class="nt">&lt;androidx.constraintlayout.widget.ConstraintLayout</span>
        <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
        <span class="na">android:layout_height=</span><span class="s">"match_parent"</span>
        <span class="na">tools:context=</span><span class="s">".MainActivity"</span> <span class="na">android:tag=</span><span class="s">"layout/activity_main_0"</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span> <span class="na">xmlns:app=</span><span class="s">"http://schemas.android.com/apk/res-auto"</span> <span class="na">xmlns:tools=</span><span class="s">"http://schemas.android.com/tools"</span><span class="nt">&gt;</span>
       //..... 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»§ç»­çœ‹aptç”Ÿæˆçš„ActivityMainBindingImplæ„é€ æ–¹æ³•:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">ActivityMainBindingImpl</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">androidx</span><span class="o">.</span><span class="na">databinding</span><span class="o">.</span><span class="na">DataBindingComponent</span> <span class="n">bindingComponent</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">View</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">bindingComponent</span><span class="o">,</span> <span class="n">root</span><span class="o">,</span> <span class="n">mapBindings</span><span class="o">(</span><span class="n">bindingComponent</span><span class="o">,</span> <span class="n">root</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="n">sIncludes</span><span class="o">,</span> <span class="n">sViewsWithIds</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»§ç»­æŸ¥çœ‹mapBindingsæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>    <span class="cm">/**
     * Walks the view hierarchy under root and pulls out tagged Views, includes, and views with
     * IDs into an Object[] that is returned. This is used to walk the view hierarchy once to find
     * all bound and ID'd views.
     *
     * @param bindingComponent The binding component to use with this binding.
     * @param root The root of the view hierarchy to walk.
     * @param numBindings The total number of ID'd views, views with expressions, and includes
     * @param includes The include layout information, indexed by their container's index.
     * @param viewsWithIds Indexes of views that don't have tags, but have IDs.
     * @return An array of size numBindings containing all Views in the hierarchy that have IDs
     * (with elements in viewsWithIds), are tagged containing expressions, or the bindings for
     * included layouts.
     * @hide
     */</span>
    <span class="kd">protected</span> <span class="kd">static</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">mapBindings</span><span class="o">(</span><span class="nc">DataBindingComponent</span> <span class="n">bindingComponent</span><span class="o">,</span> <span class="nc">View</span> <span class="n">root</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">numBindings</span><span class="o">,</span> <span class="nc">IncludedLayouts</span> <span class="n">includes</span><span class="o">,</span> <span class="nc">SparseIntArray</span> <span class="n">viewsWithIds</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">bindings</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">numBindings</span><span class="o">];</span>
        <span class="n">mapBindings</span><span class="o">(</span><span class="n">bindingComponent</span><span class="o">,</span> <span class="n">root</span><span class="o">,</span> <span class="n">bindings</span><span class="o">,</span> <span class="n">includes</span><span class="o">,</span> <span class="n">viewsWithIds</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">bindings</span><span class="o">;</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¿»è¯‘ä¸‹æ³¨é‡Šï¼š</p>
<blockquote>
  <p>åœ¨æ ¹ç›®å½•ä¸‹éå†è§†å›¾å±‚æ¬¡ç»“æ„ï¼Œå¹¶å°†å¸¦æœ‰IDçš„æ ‡è®°è§†å›¾ï¼ŒåŒ…å«è§†å›¾å’ŒIDæ”¾å…¥è¿”å›çš„Object []ä¸­ã€‚ è¿™ç”¨äºéå†è§†å›¾å±‚æ¬¡ç»“æ„ä¸€æ¬¡ä»¥æŸ¥æ‰¾æ‰€æœ‰ç»‘å®šè§†å›¾å’ŒIDè§†å›¾ã€‚</p>
</blockquote>

<p>mapBindings()éå†rootèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å¸¦tagçš„viewã€‚</p>

<p>å†çœ‹çœ‹å¦å¤–ä¸€ä¸ªé‡è½½çš„æ„é€ æ–¹æ³•:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nf">ActivityMainBindingImpl</span><span class="o">(</span><span class="n">androidx</span><span class="o">.</span><span class="na">databinding</span><span class="o">.</span><span class="na">DataBindingComponent</span> <span class="n">bindingComponent</span><span class="o">,</span> <span class="nc">View</span> <span class="n">root</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">bindings</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">bindingComponent</span><span class="o">,</span> <span class="n">root</span><span class="o">,</span> <span class="mi">1</span>
        <span class="o">,</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">Button</span><span class="o">)</span> <span class="n">bindings</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span>
        <span class="o">,</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">Button</span><span class="o">)</span> <span class="n">bindings</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span>
        <span class="o">,</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">TextView</span><span class="o">)</span> <span class="n">bindings</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
        <span class="o">,</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">TextView</span><span class="o">)</span> <span class="n">bindings</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
        <span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mboundView0</span> <span class="o">=</span> <span class="o">(</span><span class="n">androidx</span><span class="o">.</span><span class="na">constraintlayout</span><span class="o">.</span><span class="na">widget</span><span class="o">.</span><span class="na">ConstraintLayout</span><span class="o">)</span> <span class="n">bindings</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mboundView0</span><span class="o">.</span><span class="na">setTag</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">tvAge</span><span class="o">.</span><span class="na">setTag</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">tvName</span><span class="o">.</span><span class="na">setTag</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="n">setRootTag</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
    <span class="c1">// listeners</span>
    <span class="n">invalidateAll</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¿™æ ·å°±è§£ææ‰€æœ‰çš„findViewByIdçš„Viewäº†
è‡³æ­¤ï¼Œå¯ä»¥çœ‹åˆ°xmlä¸­ç”³æ˜çš„viewä¼šåœ¨è§£æé˜¶æ®µå­˜å‚¨åœ¨ActivityMainBindingImplä¸­ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆèƒ½åœ¨Activityä¸­é€šè¿‡bindingç›´æ¥è®¿é—®Viewã€‚</p>

<h3 id="å…¥å£2-bindinguser--user">å…¥å£2ï¼š binding.user = user</h3>

<p>è°ƒç”¨çš„æ˜¯ActivityMainBindingImpl.setUseræ–¹æ³•</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">//com.zhy.databinding.databinding.ActivityMainBindingImpl.java</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUser</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">com</span><span class="o">.</span><span class="na">zhy</span><span class="o">.</span><span class="na">databinding</span><span class="o">.</span><span class="na">User</span> <span class="nc">User</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">updateRegistration</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">User</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mUser</span> <span class="o">=</span> <span class="nc">User</span><span class="o">;</span>
    <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mDirtyFlags</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="no">L</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">notifyPropertyChanged</span><span class="o">(</span><span class="no">BR</span><span class="o">.</span><span class="na">user</span><span class="o">);</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">requestRebind</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»§ç»­çœ‹ä¸‹updateRegistration(0, User);</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>
<span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">updateRegistration</span><span class="o">(</span><span class="kt">int</span> <span class="n">localFieldId</span><span class="o">,</span> <span class="nc">Observable</span> <span class="n">observable</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">updateRegistration</span><span class="o">(</span><span class="n">localFieldId</span><span class="o">,</span> <span class="n">observable</span><span class="o">,</span> <span class="no">CREATE_PROPERTY_LISTENER</span><span class="o">);</span>
<span class="o">}</span>
    
</pre></td></tr></tbody></table></code></pre></div></div>
<p>CREATE_PROPERTY_LISTENERçš„ä»£ç å¦‚ä¸‹ï¼šä¸ºä¸€ä¸ªCreateWeakListenerå¸¸é‡</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">CreateWeakListener</span> <span class="no">CREATE_PROPERTY_LISTENER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CreateWeakListener</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">WeakListener</span> <span class="nf">create</span><span class="o">(</span><span class="nc">ViewDataBinding</span> <span class="n">viewDataBinding</span><span class="o">,</span> <span class="kt">int</span> <span class="n">localFieldId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">WeakPropertyListener</span><span class="o">(</span><span class="n">viewDataBinding</span><span class="o">,</span> <span class="n">localFieldId</span><span class="o">).</span><span class="na">getListener</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">};</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»§ç»­çœ‹updateRegistration(localFieldId, observable, CREATE_PROPERTY_LISTENERï¼‰æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">updateRegistration</span><span class="o">(</span><span class="kt">int</span> <span class="n">localFieldId</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">observable</span><span class="o">,</span>
        <span class="nc">CreateWeakListener</span> <span class="n">listenerCreator</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">observable</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">unregisterFrom</span><span class="o">(</span><span class="n">localFieldId</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">WeakListener</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">mLocalFieldObservers</span><span class="o">[</span><span class="n">localFieldId</span><span class="o">];</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">listener</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registerTo</span><span class="o">(</span><span class="n">localFieldId</span><span class="o">,</span> <span class="n">observable</span><span class="o">,</span> <span class="n">listenerCreator</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">listener</span><span class="o">.</span><span class="na">getTarget</span><span class="o">()</span> <span class="o">==</span> <span class="n">observable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span><span class="c1">//nothing to do, same object</span>
    <span class="o">}</span>
    <span class="n">unregisterFrom</span><span class="o">(</span><span class="n">localFieldId</span><span class="o">);</span>
    <span class="n">registerTo</span><span class="o">(</span><span class="n">localFieldId</span><span class="o">,</span> <span class="n">observable</span><span class="o">,</span> <span class="n">listenerCreator</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤æ–¹æ³•å°±æ˜¯æŠŠCreateWeakListener å’Œæ•°æ®çš„idå½¢æˆç»‘å®šå…³ç³»ï¼Œæ•°æ®çš„Idå¯é€šè¿‡BRæ–‡ä»¶å†…å®¹è·å¾—ï¼ŒBRæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.zhy.databinding</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BR</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">_all</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">user</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>nameå’Œageæ˜¯å› ä¸ºæˆ‘ä»¬é‡å†™äº†setæ–¹æ³•ï¼Œå¹¶åŠ å…¥äº†@Bindableæ³¨è§£ï¼Œè€Œuser æ˜¯å®šä¹‰åœ¨xmlä¸­çš„ï¼Œéƒ½ä¼šåœ¨BRæ–‡ä»¶ä¸­ç”Ÿæˆå¯¹åº”çš„IDï¼Œç„¶åç»§ç»­çœ‹notifyPropertyChangedæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">notifyPropertyChanged</span><span class="o">(</span><span class="kt">int</span> <span class="n">fieldId</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mCallbacks</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">mCallbacks</span><span class="o">.</span><span class="na">notifyCallbacks</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">fieldId</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¿™ä¸ªæ–¹æ³•å°±è·Ÿè¸ªåˆ°è¿™ï¼Œåé¢ä¼šç»§ç»­è®¨è®ºï¼Œæ¥ä¸‹æ¥çœ‹super.requestRebindæ–¹æ³•:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">requestRebind</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mContainingBinding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mContainingBinding</span><span class="o">.</span><span class="na">requestRebind</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">LifecycleOwner</span> <span class="n">owner</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mLifecycleOwner</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">owner</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">State</span> <span class="n">state</span> <span class="o">=</span> <span class="n">owner</span><span class="o">.</span><span class="na">getLifecycle</span><span class="o">().</span><span class="na">getCurrentState</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">state</span><span class="o">.</span><span class="na">isAtLeast</span><span class="o">(</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">State</span><span class="o">.</span><span class="na">STARTED</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span><span class="o">;</span> <span class="c1">// wait until lifecycle owner is started</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mPendingRebind</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">mPendingRebind</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="no">USE_CHOREOGRAPHER</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mChoreographer</span><span class="o">.</span><span class="na">postFrameCallback</span><span class="o">(</span><span class="n">mFrameCallback</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">mUIThreadHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">mRebindRunnable</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°æœ€åéœ€è¦Androidç‰ˆæœ¬ï¼Œä½†æ˜¯æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°mRebindRunnableï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Runnable executed on animation heartbeat to rebind the dirty Views.
 */</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Runnable</span> <span class="n">mRebindRunnable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mPendingRebind</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">processReferenceQueue</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="no">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="no">VERSION_CODES</span><span class="o">.</span><span class="na">KITKAT</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Nested so that we don't get a lint warning in IntelliJ</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mRoot</span><span class="o">.</span><span class="na">isAttachedToWindow</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// Don't execute the pending bindings until the View</span>
                <span class="c1">// is attached again.</span>
                <span class="n">mRoot</span><span class="o">.</span><span class="na">removeOnAttachStateChangeListener</span><span class="o">(</span><span class="no">ROOT_REATTACHED_LISTENER</span><span class="o">);</span>
                <span class="n">mRoot</span><span class="o">.</span><span class="na">addOnAttachStateChangeListener</span><span class="o">(</span><span class="no">ROOT_REATTACHED_LISTENER</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">executePendingBindings</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç„¶åç»§ç»­çœ‹executePendingBindingsï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Evaluates the pending bindings, updating any Views that have expressions bound to
 * modified variables. This &lt;b&gt;must&lt;/b&gt; be run on the UI thread.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">executePendingBindings</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mContainingBinding</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">executeBindingsInternal</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">mContainingBinding</span><span class="o">.</span><span class="na">executePendingBindings</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>



<span class="cm">/**
 * Evaluates the pending bindings without executing the parent bindings.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">executeBindingsInternal</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mIsExecutingPendingBindings</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">requestRebind</span><span class="o">();</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">hasPendingBindings</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">mIsExecutingPendingBindings</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">mRebindHalted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mRebindCallbacks</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mRebindCallbacks</span><span class="o">.</span><span class="na">notifyCallbacks</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">REBIND</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="c1">// The onRebindListeners will change mPendingHalted</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mRebindHalted</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mRebindCallbacks</span><span class="o">.</span><span class="na">notifyCallbacks</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">HALTED</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">mRebindHalted</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">executeBindings</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mRebindCallbacks</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mRebindCallbacks</span><span class="o">.</span><span class="na">notifyCallbacks</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">REBOUND</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">mIsExecutingPendingBindings</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™é‡Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°executeBindingsæ–¹æ³•ï¼Œä½†ä»–æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥çœ‹ä»–çš„å®ç°å°±å¥½äº†ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre>   <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">executeBindings</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">dirtyFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dirtyFlags</span> <span class="o">=</span> <span class="n">mDirtyFlags</span><span class="o">;</span>
            <span class="n">mDirtyFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">userAge</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">com</span><span class="o">.</span><span class="na">zhy</span><span class="o">.</span><span class="na">databinding</span><span class="o">.</span><span class="na">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">mUser</span><span class="o">;</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">stringValueOfUserAge</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">dirtyFlags</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="no">L</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>


            <span class="k">if</span> <span class="o">((</span><span class="n">dirtyFlags</span> <span class="o">&amp;</span> <span class="mh">0xb</span><span class="no">L</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// read user.name</span>
                        <span class="n">userName</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                    <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">dirtyFlags</span> <span class="o">&amp;</span> <span class="mh">0xd</span><span class="no">L</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// read user.age</span>
                        <span class="n">userAge</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">();</span>
                    <span class="o">}</span>


                    <span class="c1">// read String.valueOf(user.age)</span>
                    <span class="n">stringValueOfUserAge</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">userAge</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// batch finished</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">dirtyFlags</span> <span class="o">&amp;</span> <span class="mh">0xd</span><span class="no">L</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// api target 1</span>

            <span class="n">androidx</span><span class="o">.</span><span class="na">databinding</span><span class="o">.</span><span class="na">adapters</span><span class="o">.</span><span class="na">TextViewBindingAdapter</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tvAge</span><span class="o">,</span> <span class="n">stringValueOfUserAge</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">dirtyFlags</span> <span class="o">&amp;</span> <span class="mh">0xb</span><span class="no">L</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// api target 1</span>

            <span class="n">androidx</span><span class="o">.</span><span class="na">databinding</span><span class="o">.</span><span class="na">adapters</span><span class="o">.</span><span class="na">TextViewBindingAdapter</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tvName</span><span class="o">,</span> <span class="n">userName</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ°è¿™é‡Œåº”è¯¥å°±éƒ½èƒ½çœ‹çš„æ‡‚äº†ï¼Œå°±æ˜¯é€šè¿‡ä¸€å±‚å±‚å›è°ƒä»¥åæœ€ç»ˆè¿˜æ˜¯ä¼šé€šè¿‡setTextæ¥æ›´æ–°UIã€‚</p>

<h3 id="å…¥å£3notifypropertychangedbrage">å…¥å£3ï¼šnotifyPropertyChanged(BR.age)</h3>

<p>è°ƒç”¨user.age = ageæ—¶ï¼Œä¼šè°ƒç”¨user.setAge()æ–¹æ³•ï¼Œä¼šè°ƒç”¨notifyPropertyChanged(BR.age)</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">notifyPropertyChanged</span><span class="o">(</span><span class="kt">int</span> <span class="n">fieldId</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mCallbacks</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">mCallbacks</span><span class="o">.</span><span class="na">notifyCallbacks</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">fieldId</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¥ä¸Šå‰é¢çš„ï¼Œå•æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ mCallbacks.notifyCallbacksï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">notifyCallbacks</span><span class="o">(</span><span class="no">T</span> <span class="n">sender</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">,</span> <span class="no">A</span> <span class="n">arg2</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mNotificationLevel</span><span class="o">++;</span>
    <span class="n">notifyRecurse</span><span class="o">(</span><span class="n">sender</span><span class="o">,</span> <span class="n">arg</span><span class="o">,</span> <span class="n">arg2</span><span class="o">);</span>
    <span class="n">mNotificationLevel</span><span class="o">--;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mNotificationLevel</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mRemainderRemoved</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">mRemainderRemoved</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">long</span> <span class="n">removedBits</span> <span class="o">=</span> <span class="n">mRemainderRemoved</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">removedBits</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">removeRemovedCallbacks</span><span class="o">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">*</span> <span class="nc">Long</span><span class="o">.</span><span class="na">SIZE</span><span class="o">,</span> <span class="n">removedBits</span><span class="o">);</span>
                    <span class="n">mRemainderRemoved</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mFirst64Removed</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">removeRemovedCallbacks</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">mFirst64Removed</span><span class="o">);</span>
            <span class="n">mFirst64Removed</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸­é—´è°ƒç”¨ notifyRecurse()æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyRecurse</span><span class="o">(</span><span class="no">T</span> <span class="n">sender</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">,</span> <span class="no">A</span> <span class="n">arg2</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">callbackCount</span> <span class="o">=</span> <span class="n">mCallbacks</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">remainderIndex</span> <span class="o">=</span> <span class="n">mRemainderRemoved</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">mRemainderRemoved</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>

        <span class="c1">// Now we've got all callbakcs that have no mRemainderRemoved value, so notify the</span>
        <span class="c1">// others.</span>
        <span class="n">notifyRemainder</span><span class="o">(</span><span class="n">sender</span><span class="o">,</span> <span class="n">arg</span><span class="o">,</span> <span class="n">arg2</span><span class="o">,</span> <span class="n">remainderIndex</span><span class="o">);</span>

        <span class="c1">// notifyRemainder notifies all at maxIndex, so we'd normally start at maxIndex + 1</span>
        <span class="c1">// However, we must also keep track of those in mFirst64Removed, so we add 2 instead:</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">startCallbackIndex</span> <span class="o">=</span> <span class="o">(</span><span class="n">remainderIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="o">)</span> <span class="o">*</span> <span class="nc">Long</span><span class="o">.</span><span class="na">SIZE</span><span class="o">;</span>

        <span class="c1">// The remaining have no bit set</span>
        <span class="n">notifyCallbacks</span><span class="o">(</span><span class="n">sender</span><span class="o">,</span> <span class="n">arg</span><span class="o">,</span> <span class="n">arg2</span><span class="o">,</span> <span class="n">startCallbackIndex</span><span class="o">,</span> <span class="n">callbackCount</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
    
    
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyCallbacks</span><span class="o">(</span><span class="no">T</span> <span class="n">sender</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">,</span> <span class="no">A</span> <span class="n">arg2</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">startIndex</span><span class="o">,</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">endIndex</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">bits</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">bitMask</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">startIndex</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">endIndex</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">bitMask</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mNotifier</span><span class="o">.</span><span class="na">onNotifyCallback</span><span class="o">(</span><span class="n">mCallbacks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">sender</span><span class="o">,</span> <span class="n">arg</span><span class="o">,</span> <span class="n">arg2</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">bitMask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>    
</pre></td></tr></tbody></table></code></pre></div></div>

<p>mNotifier.onNotifyCallbackæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥çœ‹ä»–çš„å®ç°ç±»PropertyChangeRegistryï¼Œ
ç„¶åç»§ç»­è°ƒç”¨WeakPropertyListenerçš„onPropertyChangedæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">//WeakPropertyListener.java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPropertyChanged</span><span class="o">(</span><span class="nc">Observable</span> <span class="n">sender</span><span class="o">,</span> <span class="kt">int</span> <span class="n">propertyId</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ViewDataBinding</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">mListener</span><span class="o">.</span><span class="na">getBinder</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">binder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">Observable</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">mListener</span><span class="o">.</span><span class="na">getTarget</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="n">sender</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span> <span class="c1">// notification from the wrong object?</span>
    <span class="o">}</span>
    <span class="n">binder</span><span class="o">.</span><span class="na">handleFieldChange</span><span class="o">(</span><span class="n">mListener</span><span class="o">.</span><span class="na">mLocalFieldId</span><span class="o">,</span> <span class="n">sender</span><span class="o">,</span> <span class="n">propertyId</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆå›è°ƒåˆ°ViewDataBindçš„handleFieldChangeæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleFieldChange</span><span class="o">(</span><span class="kt">int</span> <span class="n">mLocalFieldId</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="kt">int</span> <span class="n">fieldId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mInLiveDataRegisterObserver</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// We're in LiveData registration, which always results in a field change</span>
        <span class="c1">// that we can ignore. The value will be read immediately after anyway, so</span>
        <span class="c1">// there is no need to be dirty.</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">onFieldChange</span><span class="o">(</span><span class="n">mLocalFieldId</span><span class="o">,</span> <span class="n">object</span><span class="o">,</span> <span class="n">fieldId</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">requestRebind</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ€ç»ˆè°ƒç”¨requestRebind</p>

<h3 id="registertoæ³¨å†Œç›‘å¬å™¨">registerToæ³¨å†Œç›‘å¬å™¨</h3>

<p>ç°åœ¨çœ‹ä¸‹registerToæ˜¯å¦‚ä½•ä¸ºUserçš„å±æ€§æ³¨å†Œç›‘å¬å™¨çš„</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1">//ViewDataBinding.java</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">registerTo</span><span class="o">(</span><span class="kt">int</span> <span class="n">localFieldId</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">observable</span><span class="o">,</span>
        <span class="nc">CreateWeakListener</span> <span class="n">listenerCreator</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">observable</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">WeakListener</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">mLocalFieldObservers</span><span class="o">[</span><span class="n">localFieldId</span><span class="o">];</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">listener</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">listener</span> <span class="o">=</span> <span class="n">listenerCreator</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">localFieldId</span><span class="o">);</span>
        <span class="n">mLocalFieldObservers</span><span class="o">[</span><span class="n">localFieldId</span><span class="o">]</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mLifecycleOwner</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">listener</span><span class="o">.</span><span class="na">setLifecycleOwner</span><span class="o">(</span><span class="n">mLifecycleOwner</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">listener</span><span class="o">.</span><span class="na">setTarget</span><span class="o">(</span><span class="n">observable</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤æ—¶localFieldIdæ˜¯0,å¯¹åº”BRä¸­çš„_allè¡¨ç¤ºæ‰€æœ‰BRä¸­çš„å€¼ï¼ŒlistenerCreatoræ˜¯CREATE_PROPERTY_LISTENERå¯¹è±¡ï¼Œå®ƒçš„createæ–¹æ³•å¦‚ä¸‹.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">CreateWeakListener</span> <span class="no">CREATE_PROPERTY_LISTENER</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CreateWeakListener</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">WeakListener</span> <span class="nf">create</span><span class="o">(</span><span class="nc">ViewDataBinding</span> <span class="n">viewDataBinding</span><span class="o">,</span> <span class="kt">int</span> <span class="n">localFieldId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">WeakPropertyListener</span><span class="o">(</span><span class="n">viewDataBinding</span><span class="o">,</span> <span class="n">localFieldId</span><span class="o">).</span><span class="na">getListener</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>çœ‹çœ‹WeakPropertyListener,getListener()è¿”å›çš„æ˜¯WeakPropertyListenerå¯¹è±¡</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre> <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WeakPropertyListener</span> <span class="kd">extends</span> <span class="nc">Observable</span><span class="o">.</span><span class="na">OnPropertyChangedCallback</span>
            <span class="kd">implements</span> <span class="nc">ObservableReference</span><span class="o">&lt;</span><span class="nc">Observable</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">WeakListener</span><span class="o">&lt;</span><span class="nc">Observable</span><span class="o">&gt;</span> <span class="n">mListener</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">WeakPropertyListener</span><span class="o">(</span><span class="nc">ViewDataBinding</span> <span class="n">binder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">localFieldId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mListener</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakListener</span><span class="o">&lt;</span><span class="nc">Observable</span><span class="o">&gt;(</span><span class="n">binder</span><span class="o">,</span> <span class="n">localFieldId</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">WeakListener</span><span class="o">&lt;</span><span class="nc">Observable</span><span class="o">&gt;</span> <span class="nf">getListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mListener</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>getListener()åˆè¿”å›WeakListenerå¯¹è±¡ï¼Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="c1">//androidx.databinding.ViewDataBinding.WeakListener.java</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WeakListener</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">ViewDataBinding</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ObservableReference</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">mObservable</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">mLocalFieldId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="no">T</span> <span class="n">mTarget</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">WeakListener</span><span class="o">(</span><span class="nc">ViewDataBinding</span> <span class="n">binder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">localFieldId</span><span class="o">,</span>
            <span class="nc">ObservableReference</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">observable</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">binder</span><span class="o">,</span> <span class="n">sReferenceQueue</span><span class="o">);</span>
        <span class="n">mLocalFieldId</span> <span class="o">=</span> <span class="n">localFieldId</span><span class="o">;</span>
        <span class="n">mObservable</span> <span class="o">=</span> <span class="n">observable</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLifecycleOwner</span><span class="o">(</span><span class="nc">LifecycleOwner</span> <span class="n">lifecycleOwner</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mObservable</span><span class="o">.</span><span class="na">setLifecycleOwner</span><span class="o">(</span><span class="n">lifecycleOwner</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTarget</span><span class="o">(</span><span class="no">T</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">unregister</span><span class="o">();</span>
        <span class="n">mTarget</span> <span class="o">=</span> <span class="n">object</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mTarget</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mObservable</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">mTarget</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//...     </span>
<span class="o">}</span>        
</pre></td></tr></tbody></table></code></pre></div></div>

<p>registerToæœ€åè°ƒç”¨äº†setTarget()æ–¹æ³•ï¼ŒmObservable.addListener(mTarget)ï¼ŒmObervableå°±æ˜¯ä¼ è¿‡æ¥çš„WeakPropertyListenerï¼ŒmTargetæ˜¯æˆ‘ä»¬ä¼ è¿‡æ¥çš„Userå¯¹è±¡</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">//WeakPropertyListener.java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addListener</span><span class="o">(</span><span class="nc">Observable</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">target</span><span class="o">.</span><span class="na">addOnPropertyChangedCallback</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å†åˆ°BaseObservableä¸­</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">//BaseObservable.java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addOnPropertyChangedCallback</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">OnPropertyChangedCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mCallbacks</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mCallbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PropertyChangeRegistry</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">mCallbacks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¿™æ ·å°±æŠŠWeakPropertyListenerç›‘å¬å™¨æ³¨å†Œåˆ°mCallbacks(PropertyChangeRegistry)ä¸­</p>

<h1 id="æ—¶åºå›¾">æ—¶åºå›¾</h1>

<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/ae3aea370e5fe5505827d9ece0f2b148-375349" alt="ae3aea370e5fe5505827d9ece0f2b148.png" /></p>

<p>requestRebind()æœ€ç»ˆä¼šé‡æ–°åˆ·æ–°ç•Œé¢</p>
:ET