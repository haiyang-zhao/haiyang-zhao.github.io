I"Çg<h1 id="ä»£ç†æ¨¡å¼">ä»£ç†æ¨¡å¼</h1>

<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/67b96d3d5d30eae444171b3aa2209a99-20324" alt="67b96d3d5d30eae444171b3aa2209a99.png" /></p>

<h2 id="é™æ€ä»£ç ">é™æ€ä»£ç </h2>
<p>é™æ€ä»£ç†ï¼Œæ˜¯æœ€åŸå§‹çš„ä»£ç†æ–¹å¼ï¼›å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè´­ç‰©çš„æ¥å£ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Shopping</span> <span class="o">{</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="nf">doShopping</span><span class="o">(</span><span class="kt">long</span> <span class="n">money</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å®ƒæœ‰ä¸€ä¸ªåŸå§‹çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºäº²è‡ªï¼Œç›´æ¥å»å•†åº—è´­ç‰©ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShoppingImpl</span> <span class="kd">implements</span> <span class="nc">Shopping</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">doShopping</span><span class="o">(</span><span class="kt">long</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"é€›æ·˜å® ,é€›å•†åœº,ä¹°ä¹°ä¹°!!"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"èŠ±äº†%så—é’±"</span><span class="o">,</span> <span class="n">money</span><span class="o">));</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="s">"é‹å­"</span><span class="o">,</span> <span class="s">"è¡£æœ"</span><span class="o">,</span> <span class="s">"é›¶é£Ÿ"</span> <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬è‡ªå·±æ²¡æ—¶é—´ä½†æ˜¯éœ€è¦ä¹°ä¸œè¥¿ï¼Œäºæ˜¯æˆ‘ä»¬å°±æ‰¾äº†ä¸ªä»£ç†å¸®æˆ‘ä»¬ä¹°ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyShopping</span> <span class="kd">implements</span> <span class="nc">Shopping</span> <span class="o">{</span>

    <span class="nc">Shopping</span> <span class="n">base</span><span class="o">;</span>

    <span class="nc">ProxyShopping</span><span class="o">(</span><span class="nc">Shopping</span> <span class="n">base</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">doShopping</span><span class="o">(</span><span class="kt">long</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// å…ˆé»‘ç‚¹é’±(ä¿®æ”¹è¾“å…¥å‚æ•°)</span>
        <span class="kt">long</span> <span class="n">readCost</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="n">money</span> <span class="o">*</span> <span class="mf">0.5</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"èŠ±äº†%så—é’±"</span><span class="o">,</span> <span class="n">readCost</span><span class="o">));</span>

        <span class="c1">// å¸®å¿™ä¹°ä¸œè¥¿</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">things</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="na">doShopping</span><span class="o">(</span><span class="n">readCost</span><span class="o">);</span>

        <span class="c1">// å·æ¢æ¢æŸ±(ä¿®æ”¹è¿”å›å€¼)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">things</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">things</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">things</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="s">"è¢«æ‰åŒ…çš„ä¸œè¥¿!!"</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">things</span><span class="o">;</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¾ˆä¸å¹¸ï¼Œæˆ‘ä»¬æ‰¾çš„è¿™ä¸ªä»£ç†æœ‰ç‚¹å‘ï¼Œå‘äº†æˆ‘ä»¬çš„é’±è¿˜å‘äº†æˆ‘ä»¬çš„è´§ï¼›å…ˆå¿å¿ã€‚</p>

<h2 id="åŠ¨æ€ä»£ç†">åŠ¨æ€ä»£ç†</h2>

<p>ä¼ ç»Ÿçš„é™æ€ä»£ç†æ¨¡å¼éœ€è¦ä¸ºæ¯ä¸€ä¸ªéœ€è¦ä»£ç†çš„ç±»å†™ä¸€ä¸ªä»£ç†ç±»ï¼Œå¦‚æœéœ€è¦ä»£ç†çš„ç±»æœ‰å‡ ç™¾ä¸ªé‚£ä¸æ˜¯è¦ç´¯æ­»ï¼Ÿä¸ºäº†æ›´ä¼˜é›…åœ°å®ç°ä»£ç†æ¨¡å¼ï¼ŒJDKæä¾›äº†åŠ¨æ€ä»£ç†æ–¹å¼ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºJVMå¯ä»¥åœ¨è¿è¡Œæ—¶å¸®æˆ‘ä»¬åŠ¨æ€ç”Ÿæˆä¸€ç³»åˆ—çš„ä»£ç†ç±»ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦æ‰‹å†™æ¯ä¸€ä¸ªé™æ€çš„ä»£ç†ç±»äº†ã€‚ä¾ç„¶ä»¥è´­ç‰©ä¸ºä¾‹ï¼Œç”¨åŠ¨æ€ä»£ç†å®ç°å¦‚ä¸‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Shopping</span> <span class="n">women</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ShoppingImpl</span><span class="o">();</span>
    <span class="c1">// æ­£å¸¸è´­ç‰©</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">women</span><span class="o">.</span><span class="na">doShopping</span><span class="o">(</span><span class="mi">100</span><span class="o">)));</span>
    <span class="c1">// æ‹›ä»£ç†</span>
    <span class="n">women</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Shopping</span><span class="o">)</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="nc">Shopping</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span>
            <span class="n">women</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">ShoppingHandler</span><span class="o">(</span><span class="n">women</span><span class="o">));</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">women</span><span class="o">.</span><span class="na">doShopping</span><span class="o">(</span><span class="mi">100</span><span class="o">)));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åŠ¨æ€ä»£ç†ä¸»è¦å¤„ç†InvocationHandlerå’ŒProxyç±»</p>

<h1 id="ä»£ç†hook">ä»£ç†Hook</h1>

<p>ä¸‹é¢æˆ‘ä»¬Hookæ‰startActivityè¿™ä¸ªæ–¹æ³•ï¼Œä½¿å¾—æ¯æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¹‹å‰è¾“å‡ºä¸€æ¡æ—¥å¿—ï¼›ï¼ˆå½“ç„¶ï¼Œè¿™ä¸ªè¾“å…¥æ—¥å¿—æœ‰ç‚¹ç‚¹å¼±ï¼Œåªæ˜¯ä¸ºäº†å±•ç¤ºåŸç†ï¼›åªè¦ä½ æƒ³ï¼Œä½ æƒ³å¯ä»¥æ›¿æ¢å‚æ•°ï¼Œæ‹¦æˆªè¿™ä¸ªstartActivityè¿‡ç¨‹ï¼Œä½¿å¾—è°ƒç”¨å®ƒå¯¼è‡´å¯åŠ¨æŸä¸ªåˆ«çš„Activityï¼ŒæŒ‡é¹¿ä¸ºé©¬ï¼ï¼‰</p>

<h2 id="hookç‚¹-è¢«hookçš„å¯¹è±¡">Hookç‚¹ (è¢«Hookçš„å¯¹è±¡)</h2>

<p>ä»€ä¹ˆæ ·çš„å¯¹è±¡å®¹æ˜“æ‰¾åˆ°ï¼Ÿ<strong>é™æ€å˜é‡å’Œå•ä¾‹</strong></p>

<h2 id="hook-startactivity">Hook startActivity()</h2>

<p>startActivityçš„è°ƒç”¨é“¾ï¼Œæ‰¾å‡ºåˆé€‚çš„Hookç‚¹,å¯¹äºContext.startActivityè°ƒç”¨çš„æ˜¯ConetxtImpl.startActivityæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">startActivity</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">warnIfCallingFromSystemProcess</span><span class="o">();</span>

    <span class="c1">// Calling start activity from outside an activity without FLAG_ACTIVITY_NEW_TASK is</span>
    <span class="c1">// generally not allowed, except if the caller specifies the task id the activity should</span>
    <span class="c1">// be launched in. A bug was existed between N and O-MR1 which allowed this to work. We</span>
    <span class="c1">// maintain this for backwards compatibility.</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">targetSdkVersion</span> <span class="o">=</span> <span class="n">getApplicationInfo</span><span class="o">().</span><span class="na">targetSdkVersion</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">((</span><span class="n">intent</span><span class="o">.</span><span class="na">getFlags</span><span class="o">()</span> <span class="o">&amp;</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">targetSdkVersion</span> <span class="o">&lt;</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">N</span>
                    <span class="o">||</span> <span class="n">targetSdkVersion</span> <span class="o">&gt;=</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">P</span><span class="o">)</span>
            <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">options</span> <span class="o">==</span> <span class="kc">null</span>
                    <span class="o">||</span> <span class="nc">ActivityOptions</span><span class="o">.</span><span class="na">fromBundle</span><span class="o">(</span><span class="n">options</span><span class="o">).</span><span class="na">getLaunchTaskId</span><span class="o">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">AndroidRuntimeException</span><span class="o">(</span>
                <span class="s">"Calling startActivity() from outside of an Activity "</span>
                        <span class="o">+</span> <span class="s">" context requires the FLAG_ACTIVITY_NEW_TASK flag."</span>
                        <span class="o">+</span> <span class="s">" Is this really what you want?"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">mMainThread</span><span class="o">.</span><span class="na">getInstrumentation</span><span class="o">().</span><span class="na">execStartActivity</span><span class="o">(</span>
            <span class="n">getOuterContext</span><span class="o">(),</span> <span class="n">mMainThread</span><span class="o">.</span><span class="na">getApplicationThread</span><span class="o">(),</span> <span class="kc">null</span><span class="o">,</span>
            <span class="o">(</span><span class="nc">Activity</span><span class="o">)</span> <span class="kc">null</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™é‡Œï¼Œå®é™…ä¸Šä½¿ç”¨äº†ActivityThreadç±»çš„mInstrumentationæˆå‘˜çš„execStartActivityæ–¹æ³•ï¼›æ³¨æ„åˆ°ï¼ŒActivityThread å®é™…ä¸Šæ˜¯ä¸»çº¿ç¨‹ï¼Œè€Œä¸»çº¿ç¨‹ä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªï¼Œå› æ­¤è¿™é‡Œæ˜¯ä¸€ä¸ªè‰¯å¥½çš„Hookç‚¹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nd">@UnsupportedAppUsage</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">ActivityThread</span> <span class="nf">currentActivityThread</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">sCurrentActivityThread</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ¥ä¸‹æ¥å°±æ˜¯æƒ³è¦Hookæ‰æˆ‘ä»¬çš„ä¸»çº¿ç¨‹å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æŠŠè¿™ä¸ªä¸»çº¿ç¨‹å¯¹è±¡é‡Œé¢çš„mInstrumentationç»™æ›¿æ¢æˆæˆ‘ä»¬ä¿®æ”¹è¿‡çš„ä»£ç†å¯¹è±¡ï¼›è¦æ›¿æ¢ä¸»çº¿ç¨‹å¯¹è±¡é‡Œé¢çš„å­—æ®µï¼Œé¦–å…ˆæˆ‘ä»¬å¾—æ‹¿åˆ°ä¸»çº¿ç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼Œå¦‚ä½•è·å–å‘¢ï¼ŸActivityThreadç±»é‡Œé¢æœ‰ä¸€ä¸ªé™æ€æ–¹æ³•currentActivityThreadå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ‹¿åˆ°è¿™ä¸ªå¯¹è±¡ç±»ï¼›ä½†æ˜¯ActivityThreadæ˜¯ä¸€ä¸ªéšè—ç±»ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åå°„å»è·å–ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">// å…ˆè·å–åˆ°å½“å‰çš„ActivityThreadå¯¹è±¡</span>
<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">activityThreadClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"android.app.ActivityThread"</span><span class="o">);</span>
<span class="nc">Method</span> <span class="n">currentActivityThreadMethod</span> <span class="o">=</span> <span class="n">activityThreadClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"currentActivityThread"</span><span class="o">);</span>
<span class="n">currentActivityThreadMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="nc">Object</span> <span class="n">currentActivityThread</span> <span class="o">=</span> <span class="n">currentActivityThreadMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‹¿åˆ°è¿™ä¸ªcurrentActivityThreadä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹å®ƒçš„mInstrumentationè¿™ä¸ªå­—æ®µä¸ºæˆ‘ä»¬çš„ä»£ç†å¯¹è±¡ï¼Œæˆ‘ä»¬å…ˆå®ç°è¿™ä¸ªä»£ç†å¯¹è±¡ï¼Œç”±äºJDKåŠ¨æ€ä»£ç†åªæ”¯æŒæ¥å£ï¼Œè€Œè¿™ä¸ªInstrumentationæ˜¯ä¸€ä¸ªç±»ï¼Œæ²¡åŠæ³•ï¼Œæˆ‘ä»¬åªæœ‰æ‰‹åŠ¨å†™é™æ€ä»£ç†ç±»ï¼Œè¦†ç›–æ‰åŸå§‹çš„æ–¹æ³•å³å¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Instrumentationçš„é™æ€ä»£ç†ç±»
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EvilInstrumentation</span> <span class="kd">extends</span> <span class="nc">Instrumentation</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TAG</span> <span class="o">=</span> <span class="s">"EvilInstrumentation"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Instrumentation</span> <span class="n">mBase</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">EvilInstrumentation</span><span class="o">(</span><span class="nc">Instrumentation</span> <span class="n">mBase</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mBase</span> <span class="o">=</span> <span class="n">mBase</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="nc">ActivityResult</span> <span class="nf">execStartActivity</span><span class="o">(</span>
            <span class="nc">Context</span> <span class="n">who</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">contextThread</span><span class="o">,</span> <span class="nc">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="nc">Activity</span> <span class="n">target</span><span class="o">,</span>
            <span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"execStartActivity is called."</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">mBase</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"execStartActivity"</span><span class="o">,</span>
                    <span class="nc">Context</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">IBinder</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">IBinder</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Activity</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                    <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Bundle</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

            <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">mBase</span><span class="o">,</span> <span class="n">who</span><span class="o">,</span> <span class="n">contextThread</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Okï¼Œæœ‰äº†ä»£ç†å¯¹è±¡ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯å·æ¢æ¢æŸ±ï¼ä»£ç æ¯”è¾ƒç®€å•ï¼Œé‡‡ç”¨åå°„ç›´æ¥ä¿®æ”¹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">attach</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//è·å–ActivityThreadçš„Classå¯¹è±¡</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"android.app.ActivityThread"</span><span class="o">);</span>
        <span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"currentActivityThread"</span><span class="o">);</span>

        <span class="n">method</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="c1">//currentActivityThreadæ˜¯ä¸€ä¸ªstaticå‡½æ•°æ‰€ä»¥å¯ä»¥ç›´æ¥invokeï¼Œä¸éœ€è¦å¸¦å®ä¾‹å‚æ•°</span>
        <span class="nc">Object</span> <span class="n">currentActivityThread</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="c1">//Hook ActivityThreadä¸­çš„ mInstrumentation</span>

        <span class="nc">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mInstrumentation"</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="c1">//è·å–ActivityThreadä¸­çš„ mInstrumentation</span>
        <span class="nc">Instrumentation</span> <span class="n">fieldValue</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Instrumentation</span><span class="o">)</span> <span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currentActivityThread</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">currentActivityThread</span><span class="o">,</span><span class="k">new</span> <span class="nc">EvilInstrumentation</span><span class="o">(</span><span class="n">fieldValue</span><span class="o">));</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å¥½äº†ï¼Œæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªActivityæµ‹è¯•ä¸€ä¸‹ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>

<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/9a591180c5b605449806ebc2e087065d-20123" alt="9a591180c5b605449806ebc2e087065d.png" />
å¯è§ï¼ŒHookç¡®å®æˆåŠŸäº†ï¼è¿™å°±æ˜¯ä½¿ç”¨ä»£ç†è¿›è¡ŒHookçš„åŸç†â€”â€”å·æ¢æ¢æŸ±ã€‚æ•´ä¸ªHookè¿‡ç¨‹ç®€è¦æ€»ç»“å¦‚ä¸‹ï¼š</p>

<ul>
  <li>1ã€ å¯»æ‰¾Hookç‚¹ï¼ŒåŸåˆ™æ˜¯é™æ€å˜é‡æˆ–è€…å•ä¾‹å¯¹è±¡ï¼Œå°½é‡Hook pulicçš„å¯¹è±¡å’Œæ–¹æ³•ï¼Œépublicä¸ä¿è¯æ¯ä¸ªç‰ˆæœ¬éƒ½ä¸€æ ·ï¼Œéœ€è¦é€‚é…ã€‚</li>
  <li>2ã€é€‰æ‹©åˆé€‚çš„ä»£ç†æ–¹å¼ï¼Œå¦‚æœæ˜¯æ¥å£å¯ä»¥ç”¨åŠ¨æ€ä»£ç†ï¼›å¦‚æœæ˜¯ç±»å¯ä»¥æ‰‹åŠ¨å†™ä»£ç†ä¹Ÿå¯ä»¥ä½¿ç”¨cglibã€‚</li>
  <li>3ã€å·æ¢æ¢æŸ±â€”â€”ç”¨ä»£ç†å¯¹è±¡æ›¿æ¢åŸå§‹å¯¹è±¡</li>
</ul>
:ET