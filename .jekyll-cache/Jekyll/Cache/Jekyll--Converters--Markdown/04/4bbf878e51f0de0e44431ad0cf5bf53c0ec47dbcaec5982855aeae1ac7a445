I"*–<h1 id="lifecycle">lifecycle</h1>

<blockquote>
  <p>ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶å¯æ‰§è¡Œæ“ä½œæ¥å“åº”å¦ä¸€ä¸ªç»„ä»¶ï¼ˆå¦‚ Activity å’Œ Fragmentï¼‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€çš„å˜åŒ–ã€‚è¿™äº›ç»„ä»¶æœ‰åŠ©äºæ‚¨å†™å‡ºæ›´æœ‰æ¡ç†ä¸”å¾€å¾€æ›´ç²¾ç®€çš„ä»£ç ï¼Œè¿™æ ·çš„ä»£ç æ›´æ˜“äºç»´æŠ¤ã€‚</p>
</blockquote>

<blockquote>
  <p>ä¸€ç§å¸¸è§çš„æ¨¡å¼æ˜¯åœ¨ Activity å’Œ Fragment çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­å®ç°ä¾èµ–ç»„ä»¶çš„æ“ä½œã€‚ä½†æ˜¯ï¼Œè¿™ç§æ¨¡å¼ä¼šå¯¼è‡´ä»£ç æ¡ç†æ€§å¾ˆå·®è€Œä¸”ä¼šæ‰©æ•£é”™è¯¯ã€‚é€šè¿‡ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶ï¼Œæ‚¨å¯ä»¥å°†ä¾èµ–ç»„ä»¶çš„ä»£ç ä»ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ç§»å…¥ç»„ä»¶æœ¬èº«ä¸­ã€‚</p>
</blockquote>

<p>æ¯”å¦‚åœ¨MVPæ¨¡å¼ä¸­æˆ‘ä»¬è¦åœ¨Presenterä¸­ç›‘å¬Activityçš„ç”Ÿå‘½å‘¨æœŸï¼Œä»è€Œè¿›è¡Œç›¸å…³çš„æ“ä½œã€‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">//ä¼ªä»£ç  Activity</span>

<span class="n">publlc</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">(){</span>
    <span class="n">presenter</span><span class="o">.</span><span class="na">onResume</span><span class="o">()</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è™½ç„¶æ­¤ç¤ºä¾‹çœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†åœ¨çœŸå®çš„åº”ç”¨ä¸­ï¼Œæœ€ç»ˆä¼šæœ‰å¤ªå¤šç®¡ç†ç•Œé¢å’Œå…¶ä»–ç»„ä»¶çš„è°ƒç”¨ï¼Œä»¥å“åº”ç”Ÿå‘½å‘¨æœŸçš„å½“å‰çŠ¶æ€ã€‚ç®¡ç†å¤šä¸ªç»„ä»¶ä¼šåœ¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆå¦‚ onStart() å’Œ onStop()ï¼‰ä¸­æ”¾ç½®å¤§é‡çš„ä»£ç ï¼Œè¿™ä½¿å¾—å®ƒä»¬éš¾ä»¥ç»´æŠ¤ã€‚</p>

<p>æ­¤å¤–ï¼Œæ— æ³•ä¿è¯ç»„ä»¶ä¼šåœ¨ Activity æˆ– Fragment åœæ­¢ä¹‹å‰å¯åŠ¨ã€‚åœ¨æˆ‘ä»¬éœ€è¦æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼ˆå¦‚ onStart() ä¸­çš„æŸç§é…ç½®æ£€æŸ¥ï¼‰æ—¶å°¤å…¶å¦‚æ­¤ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´å‡ºç°ä¸€ç§ç«äº‰æ¡ä»¶ï¼Œåœ¨è¿™ç§æ¡ä»¶ä¸‹ï¼ŒonStop() æ–¹æ³•ä¼šåœ¨ onStart() ä¹‹å‰ç»“æŸï¼Œè¿™ä½¿å¾—ç»„ä»¶ç•™å­˜çš„æ—¶é—´æ¯”æ‰€éœ€çš„æ—¶é—´è¦é•¿ã€‚</p>

<p>lifecycle è½¯ä»¶åŒ…æä¾›çš„ç±»å’Œæ¥å£å¯å¸®åŠ©æ‚¨ä»¥å¼¹æ€§å’Œéš”ç¦»çš„æ–¹å¼è§£å†³è¿™äº›é—®é¢˜ã€‚</p>

<h2 id="åŸºæœ¬ç”¨æ³•">åŸºæœ¬ç”¨æ³•</h2>
<p>æˆ‘ä»¬ä½¿ç”¨androidXé¡¹ç›®
Activityä¸­ä½¿ç”¨getLifecycle().addObserver()æ¥æ·»åŠ Obsever</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">GoodsActivity</span> <span class="p">:</span> <span class="nc">BaseActivity</span><span class="p">&lt;</span><span class="nc">GoodsPresenter</span><span class="p">&lt;</span><span class="nc">IGoodsView</span><span class="p">&gt;,</span> <span class="nc">IGoodsView</span><span class="p">&gt;(),</span> <span class="nc">IGoodsView</span> <span class="p">{</span>

    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">listView</span><span class="p">:</span> <span class="nc">ListView</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="nf">setContentView</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_goods</span><span class="p">)</span>
        <span class="n">listView</span> <span class="p">=</span> <span class="nf">findViewById</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">listView</span><span class="p">)</span>
        <span class="n">presenter</span><span class="p">.</span><span class="nf">attachView</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="n">presenter</span><span class="p">.</span><span class="nf">fetch</span><span class="p">()</span>


    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="c1">//æ·»åŠ observer</span>
        <span class="n">lifecycle</span><span class="p">.</span><span class="nf">addObserver</span><span class="p">(</span><span class="n">presenter</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">createPresenter</span><span class="p">():</span> <span class="nc">GoodsPresenter</span><span class="p">&lt;</span><span class="nc">IGoodsView</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">GoodsPresenter</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">showGoodsView</span><span class="p">(</span><span class="n">goods</span><span class="p">:</span> <span class="nc">MutableList</span><span class="p">&lt;</span><span class="nc">Goods</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="n">listView</span><span class="p">.</span><span class="n">adapter</span> <span class="p">=</span> <span class="nc">GoodsAdapter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">goods</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">showErrorMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Presenterå®ç°LifecycleObserveræ¥å£ï¼Œä½¿ç”¨OnLifecycleEventæ³¨è§£æ¥è®¢é˜…</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">open</span> <span class="kd">class</span> <span class="nc">BasePresenter</span><span class="p">&lt;</span><span class="k">in</span> <span class="nc">T</span> <span class="p">:</span> <span class="nc">IBaseView</span><span class="p">&gt;</span> <span class="p">:</span> <span class="nc">LifecycleObserver</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="py">iGoodsView</span><span class="p">:</span> <span class="nc">WeakReference</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="k">fun</span> <span class="nf">attachView</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="nc">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">iGoodsView</span> <span class="p">=</span> <span class="nc">WeakReference</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">detachView</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">iGoodsView</span><span class="o">?.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">iGoodsView</span> <span class="p">=</span> <span class="k">null</span>
    <span class="p">}</span>

    <span class="nd">@OnLifecycleEvent</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">Event</span><span class="p">.</span><span class="nc">ON_CREATE</span><span class="p">)</span>
    <span class="k">open</span> <span class="k">fun</span> <span class="nf">onCreateX</span><span class="p">(</span><span class="n">owner</span><span class="p">:</span> <span class="nc">LifecycleOwner</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">}</span>


    <span class="nd">@OnLifecycleEvent</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">Event</span><span class="p">.</span><span class="nc">ON_START</span><span class="p">)</span>
    <span class="k">open</span> <span class="k">fun</span> <span class="nf">onStartX</span><span class="p">(</span><span class="n">owner</span><span class="p">:</span> <span class="nc">LifecycleOwner</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">}</span>
<span class="p">}</span>   
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="ä¼˜ç‚¹">ä¼˜ç‚¹</h2>
<ul>
  <li>Lifecycleå¯ä»¥æœ‰æ•ˆçš„é¿å…å†…å­˜æ³„æ¼å’Œè§£å†³androidç”Ÿå‘½å‘¨æœŸçš„å¸¸è§éš¾é¢˜</li>
  <li>Livecycle   æ˜¯ä¸€ä¸ªè¡¨ç¤ºandroidç”Ÿå‘½å‘¨æœŸåŠçŠ¶æ€çš„å¯¹è±¡</li>
  <li>LivecycleOwner  ç”¨äºè¿æ¥æœ‰ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡</li>
  <li>LivecycleObserver  ç”¨äºè§‚å¯ŸæŸ¥LifecycleOwner
    <h2 id="åŸç†åˆ†æ">åŸç†åˆ†æ</h2>
  </li>
</ul>

<p>AppCompatActivityç»§æ‰¿ComponentActivityè€ŒComponentActivityå®ç°äº†LifecycleOwneræ¥å£ï¼Œå¹¶ä¸”æŒæœ‰LifecycleRegistryå¯¹è±¡</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LifecycleOwner</span> <span class="o">{</span>
    <span class="cm">/**
     * Returns the Lifecycle of the provider.
     *
     * @return The lifecycle of the provider.
     */</span>
    <span class="nd">@NonNull</span>
    <span class="nc">Lifecycle</span> <span class="nf">getLifecycle</span><span class="o">();</span>
<span class="o">}</span>

<span class="c1">//ComponentActivity.java</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ComponentActivity</span> <span class="kd">extends</span> <span class="n">androidx</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">ComponentActivity</span> <span class="kd">implements</span>
        <span class="nc">LifecycleOwner</span><span class="o">,</span>
        <span class="nc">ViewModelStoreOwner</span><span class="o">,</span>
        <span class="nc">SavedStateRegistryOwner</span><span class="o">,</span>
        <span class="nc">OnBackPressedDispatcherOwner</span> <span class="o">{</span>
        
    <span class="c1">//.....</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">LifecycleRegistry</span> <span class="n">mLifecycleRegistry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LifecycleRegistry</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="c1">//.....</span>
    
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">mSavedStateRegistryController</span><span class="o">.</span><span class="na">performRestore</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="c1">//å¡«å…¥ç©ºçš„Fragmentç®¡ç†ç”Ÿå‘½å‘¨æœŸ</span>
        <span class="nc">ReportFragment</span><span class="o">.</span><span class="na">injectIfNeededIn</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mContentLayoutId</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">setContentView</span><span class="o">(</span><span class="n">mContentLayoutId</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="nd">@NonNull</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Lifecycle</span> <span class="nf">getLifecycle</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mLifecycleRegistry</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>AppCompatActivity ç»§æ‰¿çš„extends androidx.core.app.ComponentActivityä¸­çš„onCretaeæ–¹æ³•
ReportFragment.injectIfNeededIn(this);å°±æ˜¯åœ¨å½“å‰çš„Activityé‡Œæ·»åŠ ä¸€ä¸ªReportFragment</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="nd">@RestrictTo</span><span class="o">(</span><span class="nc">RestrictTo</span><span class="o">.</span><span class="na">Scope</span><span class="o">.</span><span class="na">LIBRARY_GROUP_PREFIX</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReportFragment</span> <span class="kd">extends</span> <span class="nc">Fragment</span> <span class="o">{</span>
    <span class="c1">//....</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
        <span class="n">dispatchStart</span><span class="o">(</span><span class="n">mProcessListener</span><span class="o">);</span>
        <span class="n">dispatch</span><span class="o">(</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">.</span><span class="na">ON_START</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span>
        <span class="n">dispatchResume</span><span class="o">(</span><span class="n">mProcessListener</span><span class="o">);</span>
        <span class="n">dispatch</span><span class="o">(</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">.</span><span class="na">ON_RESUME</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">dispatch</span><span class="o">(</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Activity</span> <span class="n">activity</span> <span class="o">=</span> <span class="n">getActivity</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">activity</span> <span class="k">instanceof</span> <span class="nc">LifecycleRegistryOwner</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">((</span><span class="nc">LifecycleRegistryOwner</span><span class="o">)</span> <span class="n">activity</span><span class="o">).</span><span class="na">getLifecycle</span><span class="o">().</span><span class="na">handleLifecycleEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">activity</span> <span class="k">instanceof</span> <span class="nc">LifecycleOwner</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Lifecycle</span> <span class="n">lifecycle</span> <span class="o">=</span> <span class="o">((</span><span class="nc">LifecycleOwner</span><span class="o">)</span> <span class="n">activity</span><span class="o">).</span><span class="na">getLifecycle</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lifecycle</span> <span class="k">instanceof</span> <span class="nc">LifecycleRegistry</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">((</span><span class="nc">LifecycleRegistry</span><span class="o">)</span> <span class="n">lifecycle</span><span class="o">).</span><span class="na">handleLifecycleEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨ReportFragmentçš„å„ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­è°ƒç”¨dispatchæ–¹æ³•ï¼Œè€Œdispatchæ–¹æ³•è°ƒç”¨LifecycleRegistryçš„handleLifecycleEventæ–¹æ³•æ¥è½¬å‘ï¼Œè¿™æ ·ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€å°±ä¼šå€Ÿç”±LifecycleRegistryé€šçŸ¥ç»™å„ä¸ªLifecycleObserverä»è€Œè°ƒç”¨å…¶ä¸­å¯¹åº”Lifecycle.Eventçš„æ–¹æ³•ã€‚è¿™ç§é€šè¿‡Fragmentæ¥æ„ŸçŸ¥Activityç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•å…¶å®åœ¨Glideçš„ä¸­ä¹Ÿæ˜¯æœ‰ä½“ç°çš„ã€‚</p>

<p>å›åˆ°LifecycleRegistryçš„handleLifecycleEventæ–¹æ³•</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleLifecycleEvent</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">State</span> <span class="n">next</span> <span class="o">=</span> <span class="n">getStateAfter</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
    <span class="n">moveToState</span><span class="o">(</span><span class="n">next</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">static</span> <span class="nc">State</span> <span class="nf">getStateAfter</span><span class="o">(</span><span class="nc">Event</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">ON_CREATE:</span>
        <span class="k">case</span> <span class="nl">ON_STOP:</span>
            <span class="k">return</span> <span class="no">CREATED</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">ON_START:</span>
        <span class="k">case</span> <span class="nl">ON_PAUSE:</span>
            <span class="k">return</span> <span class="no">STARTED</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">ON_RESUME:</span>
            <span class="k">return</span> <span class="no">RESUMED</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">ON_DESTROY:</span>
            <span class="k">return</span> <span class="no">DESTROYED</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">ON_ANY:</span>
            <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Unexpected event value "</span> <span class="o">+</span> <span class="n">event</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">moveToState</span><span class="o">(</span><span class="nc">State</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mState</span> <span class="o">==</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">mState</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mHandlingEvent</span> <span class="o">||</span> <span class="n">mAddingObserverCounter</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mNewEventOccurred</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="c1">// we will figure out what to do on upper level.</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">mHandlingEvent</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">sync</span><span class="o">();</span>
    <span class="n">mHandlingEvent</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>getStateAfteræ–¹æ³•è·å–å½“å‰çŠ¶æ€çš„ä¸‹ä¸€ä¸ªçŠ¶æ€,ä¸‹å›¾ä¸ºAndroid Activity ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€å’Œäº‹ä»¶
<img src="https://app.yinxiang.com/FileSharing.action?hash=1/b3d09df9ab5e66e392787a0c96c0d83e-198931" alt="5a819b83be1b2afed824247ed332b490.svg+xml" />@w=1000
moveToState(next)ä¸­ï¼Œå°†mState=nextï¼Œå†è°ƒç”¨syncæ–¹æ³•åŒæ­¥çŠ¶æ€ï¼Œçœ‹çœ‹syncæ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">sync</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">LifecycleOwner</span> <span class="n">lifecycleOwner</span> <span class="o">=</span> <span class="n">mLifecycleOwner</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lifecycleOwner</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"LifecycleOwner of this LifecycleRegistry is already"</span>
                <span class="o">+</span> <span class="s">"garbage collected. It is too late to change lifecycle state."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">while</span> <span class="o">(!</span><span class="n">isSynced</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">mNewEventOccurred</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="c1">// no need to check eldest for nullability, because isSynced does it for us.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mState</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">mObserverMap</span><span class="o">.</span><span class="na">eldest</span><span class="o">().</span><span class="na">getValue</span><span class="o">().</span><span class="na">mState</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//é€†æ¨</span>
            <span class="n">backwardPass</span><span class="o">(</span><span class="n">lifecycleOwner</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">LifecycleObserver</span><span class="o">,</span> <span class="nc">ObserverWithState</span><span class="o">&gt;</span> <span class="n">newest</span> <span class="o">=</span> <span class="n">mObserverMap</span><span class="o">.</span><span class="na">newest</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mNewEventOccurred</span> <span class="o">&amp;&amp;</span> <span class="n">newest</span> <span class="o">!=</span> <span class="kc">null</span>
                <span class="o">&amp;&amp;</span> <span class="n">mState</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">newest</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">mState</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//æ­£æ¨</span>
            <span class="n">forwardPass</span><span class="o">(</span><span class="n">lifecycleOwner</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">mNewEventOccurred</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>backwardPasså’ŒforwardPassæ–¹æ³•æ¨å¯¼çš„çŠ¶æ€å¯ä»¥ä»ä¸Šé¢çš„å›¾åˆ†æåˆ°ï¼Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">backwardPass</span><span class="o">(</span><span class="nc">LifecycleOwner</span> <span class="n">lifecycleOwner</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">LifecycleObserver</span><span class="o">,</span> <span class="nc">ObserverWithState</span><span class="o">&gt;&gt;</span> <span class="n">descendingIterator</span> <span class="o">=</span>
            <span class="n">mObserverMap</span><span class="o">.</span><span class="na">descendingIterator</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">descendingIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mNewEventOccurred</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">LifecycleObserver</span><span class="o">,</span> <span class="nc">ObserverWithState</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">descendingIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="nc">ObserverWithState</span> <span class="n">observer</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">observer</span><span class="o">.</span><span class="na">mState</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">mState</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mNewEventOccurred</span>
                <span class="o">&amp;&amp;</span> <span class="n">mObserverMap</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">())))</span> <span class="o">{</span>
            <span class="nc">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="n">downEvent</span><span class="o">(</span><span class="n">observer</span><span class="o">.</span><span class="na">mState</span><span class="o">);</span>
            <span class="n">pushParentState</span><span class="o">(</span><span class="n">getStateAfter</span><span class="o">(</span><span class="n">event</span><span class="o">));</span>
            <span class="c1">//è°ƒç”¨å„ä¸ªObserverWithStateçš„dispatchEventæ–¹æ³•</span>
            <span class="n">observer</span><span class="o">.</span><span class="na">dispatchEvent</span><span class="o">(</span><span class="n">lifecycleOwner</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="n">popParentState</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ObserverWithStateç±»å¦‚ä¸‹</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">class</span> <span class="nc">ObserverWithState</span> <span class="o">{</span>
    <span class="nc">State</span> <span class="n">mState</span><span class="o">;</span>
    <span class="nc">LifecycleEventObserver</span> <span class="n">mLifecycleObserver</span><span class="o">;</span>

    <span class="nc">ObserverWithState</span><span class="o">(</span><span class="nc">LifecycleObserver</span> <span class="n">observer</span><span class="o">,</span> <span class="nc">State</span> <span class="n">initialState</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//åˆ›å»ºLifecycleEventObserver</span>
        <span class="n">mLifecycleObserver</span> <span class="o">=</span> <span class="nc">Lifecycling</span><span class="o">.</span><span class="na">lifecycleEventObserver</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
        <span class="n">mState</span> <span class="o">=</span> <span class="n">initialState</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">dispatchEvent</span><span class="o">(</span><span class="nc">LifecycleOwner</span> <span class="n">owner</span><span class="o">,</span> <span class="nc">Event</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">State</span> <span class="n">newState</span> <span class="o">=</span> <span class="n">getStateAfter</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
        <span class="n">mState</span> <span class="o">=</span> <span class="n">min</span><span class="o">(</span><span class="n">mState</span><span class="o">,</span> <span class="n">newState</span><span class="o">);</span>
        <span class="n">mLifecycleObserver</span><span class="o">.</span><span class="na">onStateChanged</span><span class="o">(</span><span class="n">owner</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
        <span class="n">mState</span> <span class="o">=</span> <span class="n">newState</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//Lifecycling.java</span>
<span class="nd">@NonNull</span>
<span class="kd">static</span> <span class="nc">LifecycleEventObserver</span> <span class="nf">lifecycleEventObserver</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">isLifecycleEventObserver</span> <span class="o">=</span> <span class="n">object</span> <span class="k">instanceof</span> <span class="nc">LifecycleEventObserver</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">isFullLifecycleObserver</span> <span class="o">=</span> <span class="n">object</span> <span class="k">instanceof</span> <span class="nc">FullLifecycleObserver</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isLifecycleEventObserver</span> <span class="o">&amp;&amp;</span> <span class="n">isFullLifecycleObserver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">FullLifecycleObserverAdapter</span><span class="o">((</span><span class="nc">FullLifecycleObserver</span><span class="o">)</span> <span class="n">object</span><span class="o">,</span>
                <span class="o">(</span><span class="nc">LifecycleEventObserver</span><span class="o">)</span> <span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isFullLifecycleObserver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">FullLifecycleObserverAdapter</span><span class="o">((</span><span class="nc">FullLifecycleObserver</span><span class="o">)</span> <span class="n">object</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isLifecycleEventObserver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">LifecycleEventObserver</span><span class="o">)</span> <span class="n">object</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">getObserverConstructorType</span><span class="o">(</span><span class="n">klass</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="no">GENERATED_CALLBACK</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Constructor</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GeneratedAdapter</span><span class="o">&gt;&gt;</span> <span class="n">constructors</span> <span class="o">=</span>
                <span class="n">sClassToAdapters</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">klass</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">constructors</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">GeneratedAdapter</span> <span class="n">generatedAdapter</span> <span class="o">=</span> <span class="n">createGeneratedAdapter</span><span class="o">(</span>
                    <span class="n">constructors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">object</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">SingleGeneratedAdapterObserver</span><span class="o">(</span><span class="n">generatedAdapter</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">GeneratedAdapter</span><span class="o">[]</span> <span class="n">adapters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GeneratedAdapter</span><span class="o">[</span><span class="n">constructors</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">constructors</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">adapters</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">createGeneratedAdapter</span><span class="o">(</span><span class="n">constructors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">object</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">CompositeGeneratedAdaptersObserver</span><span class="o">(</span><span class="n">adapters</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//ç§å­</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ReflectiveGenericLifecycleObserver</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>dispatchEventæ–¹æ³•è°ƒç”¨äº†LifecycleEventObserverçš„onStateChangedæ–¹æ³•ï¼ŒLifecycling.lifecycleEventObserveræ–¹æ³•è¿”å›äº†ä¸€ä¸ªReflectiveGenericLifecycleObserverå¯¹è±¡ï¼Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">ReflectiveGenericLifecycleObserver</span> <span class="kd">implements</span> <span class="nc">LifecycleEventObserver</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">mWrapped</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CallbackInfo</span> <span class="n">mInfo</span><span class="o">;</span>

    <span class="nc">ReflectiveGenericLifecycleObserver</span><span class="o">(</span><span class="nc">Object</span> <span class="n">wrapped</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mWrapped</span> <span class="o">=</span> <span class="n">wrapped</span><span class="o">;</span>
        <span class="c1">//åˆ›å»ºCallbackInfo</span>
        <span class="n">mInfo</span> <span class="o">=</span> <span class="nc">ClassesInfoCache</span><span class="o">.</span><span class="na">sInstance</span><span class="o">.</span><span class="na">getInfo</span><span class="o">(</span><span class="n">mWrapped</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStateChanged</span><span class="o">(</span><span class="nc">LifecycleOwner</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Event</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//</span>
        <span class="n">mInfo</span><span class="o">.</span><span class="na">invokeCallbacks</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">event</span><span class="o">,</span> <span class="n">mWrapped</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ReflectiveGenericLifecycleObserverçš„æ„é€ æ–¹æ³•ä¸­é¦–å…ˆåˆ›å»ºCallbackInfoå¯¹è±¡mInfo,</p>

<p>çœ‹ä¸‹ClassesInfoCache.sInstance.getInfo(mWrapped.getClass())æ˜¯å¦‚ä½•è¿”å›CallbackInfoçš„</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="rouge-code"><pre><span class="c1">//ClassesInfoCache.java</span>
<span class="nc">CallbackInfo</span> <span class="nf">getInfo</span><span class="o">(</span><span class="nc">Class</span> <span class="n">klass</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">CallbackInfo</span> <span class="n">existing</span> <span class="o">=</span> <span class="n">mCallbackMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">klass</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">existing</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">existing</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">existing</span> <span class="o">=</span> <span class="n">createInfo</span><span class="o">(</span><span class="n">klass</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">existing</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="nc">CallbackInfo</span> <span class="nf">createInfo</span><span class="o">(</span><span class="nc">Class</span> <span class="n">klass</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Method</span><span class="o">[]</span> <span class="n">declaredMethods</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//è·å–çˆ¶ç±»çš„mHandlerToEvent</span>
    <span class="nc">Class</span> <span class="n">superclass</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">MethodReference</span><span class="o">,</span> <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">&gt;</span> <span class="n">handlerToEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">superclass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">CallbackInfo</span> <span class="n">superInfo</span> <span class="o">=</span> <span class="n">getInfo</span><span class="o">(</span><span class="n">superclass</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">superInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handlerToEvent</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">superInfo</span><span class="o">.</span><span class="na">mHandlerToEvent</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">Class</span><span class="o">[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span> <span class="n">intrfc</span> <span class="o">:</span> <span class="n">interfaces</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">MethodReference</span><span class="o">,</span> <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">getInfo</span><span class="o">(</span>
                <span class="n">intrfc</span><span class="o">).</span><span class="na">mHandlerToEvent</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">verifyAndPutHandler</span><span class="o">(</span><span class="n">handlerToEvent</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="n">klass</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">declaredMethods</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">declaredMethods</span> <span class="o">:</span> <span class="n">getDeclaredMethods</span><span class="o">(</span><span class="n">klass</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">hasLifecycleMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//è·å–æ‰€ä»¥å¸¦OnLifecycleEventæ³¨è§£çš„æ–¹æ³•</span>
        <span class="nc">OnLifecycleEvent</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">OnLifecycleEvent</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">hasLifecycleMethods</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">params</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">callType</span> <span class="o">=</span> <span class="no">CALL_TYPE_NO_ARG</span><span class="o">;</span>
        <span class="c1">//æ–¹æ³•å‚æ•°å¤§äº0</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">callType</span> <span class="o">=</span> <span class="no">CALL_TYPE_PROVIDER</span><span class="o">;</span>
            <span class="c1">//ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯LifecycleOwnerç±»å‹</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="nc">LifecycleOwner</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
                        <span class="s">"invalid parameter type. Must be one and instanceof LifecycleOwner"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
        <span class="c1">//æ ¡éªŒç¬¬äºŒä¸ªå‚æ•°å¿…é¡»æ˜¯Lifecycle.Event.ON_ANY</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">callType</span> <span class="o">=</span> <span class="no">CALL_TYPE_PROVIDER_WITH_EVENT</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">params</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
                        <span class="s">"invalid parameter type. second arg must be an event"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="o">!=</span> <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">.</span><span class="na">ON_ANY</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
                        <span class="s">"Second arg is supported only for ON_ANY value"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//æ–¹æ³•å‚æ•°ä¸èƒ½å¤§äº2</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"cannot have more than 2 params"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">MethodReference</span> <span class="n">methodReference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MethodReference</span><span class="o">(</span><span class="n">callType</span><span class="o">,</span> <span class="n">method</span><span class="o">);</span>
        <span class="n">verifyAndPutHandler</span><span class="o">(</span><span class="n">handlerToEvent</span><span class="o">,</span> <span class="n">methodReference</span><span class="o">,</span> <span class="n">event</span><span class="o">,</span> <span class="n">klass</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">CallbackInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CallbackInfo</span><span class="o">(</span><span class="n">handlerToEvent</span><span class="o">);</span>
    <span class="n">mCallbackMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">klass</span><span class="o">,</span> <span class="n">info</span><span class="o">);</span>
    <span class="n">mHasLifecycleMethods</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">klass</span><span class="o">,</span> <span class="n">hasLifecycleMethods</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>CallbackInfoä¸­çš„invokeCallbacksé€šè¿‡æ–¹å¼è°ƒç”¨Methodçš„invokeæ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">class</span> <span class="nc">CallbackInfo</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MethodReference</span><span class="o">&gt;&gt;</span> <span class="n">mEventToHandlers</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">MethodReference</span><span class="o">,</span> <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">&gt;</span> <span class="n">mHandlerToEvent</span><span class="o">;</span>

    <span class="nc">CallbackInfo</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">MethodReference</span><span class="o">,</span> <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">&gt;</span> <span class="n">handlerToEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mHandlerToEvent</span> <span class="o">=</span> <span class="n">handlerToEvent</span><span class="o">;</span>
        <span class="n">mEventToHandlers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">MethodReference</span><span class="o">,</span> <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">handlerToEvent</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span> <span class="n">event</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">MethodReference</span><span class="o">&gt;</span> <span class="n">methodReferences</span> <span class="o">=</span> <span class="n">mEventToHandlers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">methodReferences</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">methodReferences</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
                <span class="n">mEventToHandlers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">methodReferences</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">methodReferences</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"ConstantConditions"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">invokeCallbacks</span><span class="o">(</span><span class="nc">LifecycleOwner</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span> <span class="n">event</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">invokeMethodsForEvent</span><span class="o">(</span><span class="n">mEventToHandlers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">event</span><span class="o">),</span> <span class="n">source</span><span class="o">,</span> <span class="n">event</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
        <span class="n">invokeMethodsForEvent</span><span class="o">(</span><span class="n">mEventToHandlers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span><span class="o">.</span><span class="na">ON_ANY</span><span class="o">),</span> <span class="n">source</span><span class="o">,</span> <span class="n">event</span><span class="o">,</span>
                <span class="n">target</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeMethodsForEvent</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">MethodReference</span><span class="o">&gt;</span> <span class="n">handlers</span><span class="o">,</span>
            <span class="nc">LifecycleOwner</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span> <span class="n">event</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">mWrapped</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">handlers</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">handlers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
                
                <span class="n">handlers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">invokeCallback</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">event</span><span class="o">,</span> <span class="n">mWrapped</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodReference</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">mCallType</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Method</span> <span class="n">mMethod</span><span class="o">;</span>

        <span class="nc">MethodReference</span><span class="o">(</span><span class="kt">int</span> <span class="n">callType</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mCallType</span> <span class="o">=</span> <span class="n">callType</span><span class="o">;</span>
            <span class="n">mMethod</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
            <span class="n">mMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">//é€šè¿‡æ–¹å¼è°ƒç”¨</span>
        <span class="kt">void</span> <span class="nf">invokeCallback</span><span class="o">(</span><span class="nc">LifecycleOwner</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Lifecycle</span><span class="o">.</span><span class="na">Event</span> <span class="n">event</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//noinspection TryWithIdenticalCatches</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">switch</span> <span class="o">(</span><span class="n">mCallType</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="nl">CALL_TYPE_NO_ARG:</span>
                        <span class="n">mMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="nl">CALL_TYPE_PROVIDER:</span>
                        <span class="n">mMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="nl">CALL_TYPE_PROVIDER_WITH_EVENT:</span>
                        <span class="n">mMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">source</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Failed to call observer method"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//....</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å†æ¥çœ‹çœ‹LifecycleRegistryçš„addObserveræ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="nc">CallbackInfo</span> <span class="nf">createInfo</span><span class="o">(</span><span class="nc">Class</span> <span class="n">klass</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Method</span><span class="o">[]</span> <span class="n">declaredMethods</span><span class="o">)</span> <span class="o">{}</span>
<span class="o">....</span>
<span class="kd">private</span> <span class="nc">FastSafeIterableMap</span><span class="o">&lt;</span><span class="nc">LifecycleObserver</span><span class="o">,</span> <span class="nc">ObserverWithState</span><span class="o">&gt;</span> <span class="n">mObserverMap</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nc">FastSafeIterableMap</span><span class="o">&lt;&gt;();</span>
<span class="o">....</span>          
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addObserver</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">LifecycleObserver</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//åˆå§‹åŒ–çŠ¶æ€</span>
    <span class="nc">State</span> <span class="n">initialState</span> <span class="o">=</span> <span class="n">mState</span> <span class="o">==</span> <span class="no">DESTROYED</span> <span class="o">?</span> <span class="no">DESTROYED</span> <span class="o">:</span> <span class="no">INITIALIZED</span><span class="o">;</span>
    <span class="c1">//åˆ›å»ºObserverWithStateå¯¹è±¡</span>
    <span class="nc">ObserverWithState</span> <span class="n">statefulObserver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObserverWithState</span><span class="o">(</span><span class="n">observer</span><span class="o">,</span> <span class="n">initialState</span><span class="o">);</span>
    <span class="c1">//æŠŠObserverWithStateæ”¾åˆ°FastSafeIterableMapä¸­</span>
    <span class="nc">ObserverWithState</span> <span class="n">previous</span> <span class="o">=</span> <span class="n">mObserverMap</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">observer</span><span class="o">,</span> <span class="n">statefulObserver</span><span class="o">);</span>
    <span class="c1">//ç¬¬ä¸€æ¬¡æ”¾åˆ°mapæ—¶ï¼Œpreviousæ˜¯null</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">previous</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//lifecycleOwnerå°±æ˜¯å‰é¢çš„Activity</span>
    <span class="nc">LifecycleOwner</span> <span class="n">lifecycleOwner</span> <span class="o">=</span> <span class="n">mLifecycleOwner</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lifecycleOwner</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// it is null we should be destroyed. Fallback quickly</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="n">isReentrance</span> <span class="o">=</span> <span class="n">mAddingObserverCounter</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mHandlingEvent</span><span class="o">;</span>
    <span class="nc">State</span> <span class="n">targetState</span> <span class="o">=</span> <span class="n">calculateTargetState</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span><span class="c1">//(1)</span>
    <span class="n">mAddingObserverCounter</span><span class="o">++;</span>
   <span class="c1">//</span>
    <span class="k">while</span> <span class="o">((</span><span class="n">statefulObserver</span><span class="o">.</span><span class="na">mState</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">targetState</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="o">&amp;&amp;</span> <span class="n">mObserverMap</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">observer</span><span class="o">)))</span> <span class="o">{</span>
        <span class="n">pushParentState</span><span class="o">(</span><span class="n">statefulObserver</span><span class="o">.</span><span class="na">mState</span><span class="o">);</span>
        <span class="n">statefulObserver</span><span class="o">.</span><span class="na">dispatchEvent</span><span class="o">(</span><span class="n">lifecycleOwner</span><span class="o">,</span> <span class="n">upEvent</span><span class="o">(</span><span class="n">statefulObserver</span><span class="o">.</span><span class="na">mState</span><span class="o">));</span>
        <span class="n">popParentState</span><span class="o">();</span>
        <span class="c1">// mState / subling may have been changed recalculate</span>
        <span class="n">targetState</span> <span class="o">=</span> <span class="n">calculateTargetState</span><span class="o">(</span><span class="n">observer</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">isReentrance</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// we do sync only on the top level.</span>
        <span class="n">sync</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">mAddingObserverCounter</span><span class="o">--;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æµç¨‹å›¾å¦‚ä¸‹ï¼š
<img src="https://app.yinxiang.com/FileSharing.action?hash=1/cfab40026e9ad127df2595be60b8bf66-124083" alt="cfab40026e9ad127df2595be60b8bf66.png" /></p>

<h1 id="livedata">livedata</h1>
<p>livedata is a observable</p>

<blockquote>
  <p>LiveData æ˜¯ä¸€ç§å¯è§‚å¯Ÿçš„æ•°æ®å­˜å‚¨å™¨ç±»ã€‚ä¸å¸¸è§„çš„å¯è§‚å¯Ÿç±»ä¸åŒï¼ŒLiveData å…·æœ‰ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥èƒ½åŠ›ï¼Œæ„æŒ‡å®ƒéµå¾ªå…¶ä»–åº”ç”¨ç»„ä»¶ï¼ˆå¦‚ Activityã€Fragment æˆ– Serviceï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™ç§æ„ŸçŸ¥èƒ½åŠ›å¯ç¡®ä¿ LiveData ä»…æ›´æ–°å¤„äºæ´»è·ƒç”Ÿå‘½å‘¨æœŸçŠ¶æ€çš„åº”ç”¨ç»„ä»¶è§‚å¯Ÿè€…</p>
</blockquote>

<p>å¦‚æœè§‚å¯Ÿè€…ï¼ˆç”± Observer ç±»è¡¨ç¤ºï¼‰çš„ç”Ÿå‘½å‘¨æœŸå¤„äº STARTED æˆ– RESUMED çŠ¶æ€ï¼Œåˆ™ LiveData ä¼šè®¤ä¸ºè¯¥è§‚å¯Ÿè€…å¤„äºæ´»è·ƒçŠ¶æ€ã€‚LiveData åªä¼šå°†æ›´æ–°é€šçŸ¥ç»™æ´»è·ƒçš„è§‚å¯Ÿè€…ã€‚ä¸ºè§‚å¯Ÿ LiveData å¯¹è±¡è€Œæ³¨å†Œçš„éæ´»è·ƒè§‚å¯Ÿè€…ä¸ä¼šæ”¶åˆ°æ›´æ”¹é€šçŸ¥ã€‚</p>

<h2 id="ä¼˜åŠ¿">ä¼˜åŠ¿</h2>
<ul>
  <li>ç¡®ä¿ç•Œé¢ç¬¦åˆæ•°æ®çŠ¶æ€
    <blockquote>
      <p>LiveData éµå¾ªè§‚å¯Ÿè€…æ¨¡å¼ã€‚å½“ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒLiveData ä¼šé€šçŸ¥ Observer å¯¹è±¡ã€‚æ‚¨å¯ä»¥æ•´åˆä»£ç ä»¥åœ¨è¿™äº› Observer å¯¹è±¡ä¸­æ›´æ–°ç•Œé¢ã€‚è§‚å¯Ÿè€…å¯ä»¥åœ¨æ¯æ¬¡å‘ç”Ÿæ›´æ”¹æ—¶æ›´æ–°ç•Œé¢ï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡åº”ç”¨æ•°æ®å‘ç”Ÿæ›´æ”¹æ—¶æ›´æ–°ç•Œé¢ã€‚</p>
    </blockquote>
  </li>
  <li>ä¸ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼
    <blockquote>
      <p>è§‚å¯Ÿè€…ä¼šç»‘å®šåˆ° Lifecycle å¯¹è±¡ï¼Œå¹¶åœ¨å…¶å…³è”çš„ç”Ÿå‘½å‘¨æœŸé­åˆ°é”€æ¯åè¿›è¡Œè‡ªæˆ‘æ¸…ç†ã€‚</p>
    </blockquote>
  </li>
  <li>ä¸ä¼šå›  Activity åœæ­¢è€Œå¯¼è‡´å´©æºƒ
    <blockquote>
      <p>å¦‚æœè§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸå¤„äºéæ´»è·ƒçŠ¶æ€ï¼ˆå¦‚è¿”å›æ ˆä¸­çš„ Activityï¼‰ï¼Œåˆ™å®ƒä¸ä¼šæ¥æ”¶ä»»ä½• LiveData äº‹ä»¶ã€‚</p>
    </blockquote>
  </li>
  <li>ä¸å†éœ€è¦æ‰‹åŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ
    <blockquote>
      <p>ç•Œé¢ç»„ä»¶åªæ˜¯è§‚å¯Ÿç›¸å…³æ•°æ®ï¼Œä¸ä¼šåœæ­¢æˆ–æ¢å¤è§‚å¯Ÿã€‚LiveData å°†è‡ªåŠ¨ç®¡ç†æ‰€æœ‰è¿™äº›æ“ä½œï¼Œå› ä¸ºå®ƒåœ¨è§‚å¯Ÿæ—¶å¯ä»¥æ„ŸçŸ¥ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å˜åŒ–ã€‚</p>
    </blockquote>
  </li>
  <li>æ•°æ®å§‹ç»ˆä¿æŒæœ€æ–°çŠ¶æ€
    <blockquote>
      <p>å¦‚æœç”Ÿå‘½å‘¨æœŸå˜ä¸ºéæ´»è·ƒçŠ¶æ€ï¼Œå®ƒä¼šåœ¨å†æ¬¡å˜ä¸ºæ´»è·ƒçŠ¶æ€æ—¶æ¥æ”¶æœ€æ–°çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæ›¾ç»åœ¨åå°çš„ Activity ä¼šåœ¨è¿”å›å‰å°åç«‹å³æ¥æ”¶æœ€æ–°çš„æ•°æ®ã€‚</p>
    </blockquote>
  </li>
  <li>é€‚å½“çš„é…ç½®æ›´æ”¹
    <blockquote>
      <p>å¦‚æœç”±äºé…ç½®æ›´æ”¹ï¼ˆå¦‚è®¾å¤‡æ—‹è½¬ï¼‰è€Œé‡æ–°åˆ›å»ºäº† Activity æˆ– Fragmentï¼Œå®ƒä¼šç«‹å³æ¥æ”¶æœ€æ–°çš„å¯ç”¨æ•°æ®ã€‚</p>
    </blockquote>
  </li>
  <li>å…±äº«èµ„æº
    <blockquote>
      <p>æ‚¨å¯ä»¥ä½¿ç”¨å•ä¸€å®ä¾‹æ¨¡å¼æ‰©å±• LiveData å¯¹è±¡ä»¥å°è£…ç³»ç»ŸæœåŠ¡ï¼Œä»¥ä¾¿åœ¨åº”ç”¨ä¸­å…±äº«å®ƒä»¬ã€‚LiveData å¯¹è±¡è¿æ¥åˆ°ç³»ç»ŸæœåŠ¡ä¸€æ¬¡ï¼Œç„¶åéœ€è¦ç›¸åº”èµ„æºçš„ä»»ä½•è§‚å¯Ÿè€…åªéœ€è§‚å¯Ÿ LiveData å¯¹è±¡</p>
    </blockquote>
  </li>
</ul>

<h2 id="ä½¿ç”¨livedataå¯¹è±¡">ä½¿ç”¨LiveDataå¯¹è±¡</h2>

<p>æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä½¿ç”¨LiveData</p>

<ol>
  <li>åˆ›å»º LiveData å®ä¾‹ä»¥å­˜å‚¨æŸç§ç±»å‹çš„æ•°æ®ã€‚è¿™é€šå¸¸åœ¨ <strong>ViewModel</strong> ç±»ä¸­å®Œæˆã€‚</li>
  <li>åˆ›å»ºå¯å®šä¹‰ onChanged() æ–¹æ³•çš„ Observer å¯¹è±¡ï¼Œè¯¥æ–¹æ³•å¯ä»¥æ§åˆ¶å½“ LiveData å¯¹è±¡å­˜å‚¨çš„æ•°æ®æ›´æ”¹æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åœ¨ç•Œé¢æ§åˆ¶å™¨ï¼ˆå¦‚ Activity æˆ– Fragmentï¼‰ä¸­åˆ›å»º Observer å¯¹è±¡ã€‚</li>
  <li>ä½¿ç”¨ observe() æ–¹æ³•å°† Observer å¯¹è±¡é™„åŠ åˆ° LiveData å¯¹è±¡ã€‚observe() æ–¹æ³•ä¼šé‡‡ç”¨ LifecycleOwner å¯¹è±¡ã€‚è¿™æ ·ä¼šä½¿ Observer å¯¹è±¡è®¢é˜… LiveData å¯¹è±¡ï¼Œä»¥ä½¿å…¶æ”¶åˆ°æœ‰å…³æ›´æ”¹çš„é€šçŸ¥ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åœ¨ç•Œé¢æ§åˆ¶å™¨ï¼ˆå¦‚ Activity æˆ– Fragmentï¼‰ä¸­é™„åŠ  Observer å¯¹è±¡ã€‚</li>
</ol>

<p>å…·ä½“ç¤ºä¾‹ä»£ç å¦‚ä¸‹:</p>

<h3 id="åˆ›å»º-livedata-å¯¹è±¡">åˆ›å»º LiveData å¯¹è±¡</h3>
<p>LiveData æ˜¯ä¸€ç§å¯ç”¨äºä»»ä½•æ•°æ®çš„å°è£…å®¹å™¨ï¼Œå…¶ä¸­åŒ…æ‹¬å¯å®ç° Collections çš„å¯¹è±¡ï¼Œå¦‚ Listã€‚LiveData å¯¹è±¡é€šå¸¸å­˜å‚¨åœ¨ ViewModel å¯¹è±¡ä¸­ï¼Œå¹¶å¯é€šè¿‡ getter æ–¹æ³•è¿›è¡Œè®¿é—®ï¼Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">LiveData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">//...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>LiveDataæ˜¯ä¸ªæŠ½è±¡ç±»,ä»–çš„å®ç°ç±»å¦‚ä¸‹ï¼Œä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨MutableLiveData</p>

<p><img src="https://app.yinxiang.com/FileSharing.action?hash=1/14c125ffe1fb55ad235fbcdb32e27f21-107088" alt="14c125ffe1fb55ad235fbcdb32e27f21.png" />@w=500</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">NameViewModel</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//Create a LiveData with a String</span>
    <span class="kd">val</span> <span class="py">currentName</span><span class="p">:</span> <span class="nc">MutableLiveData</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="k">by</span> <span class="nf">lazy</span> <span class="p">{</span>
        <span class="nc">MutableLiveData</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="è§‚å¯Ÿ-livedata-å¯¹è±¡">è§‚å¯Ÿ LiveData å¯¹è±¡</h3>

<p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåº”ç”¨ç»„ä»¶çš„ onCreate() æ–¹æ³•æ˜¯å¼€å§‹è§‚å¯Ÿ LiveData å¯¹è±¡çš„æ­£ç¡®ç€æ‰‹ç‚¹ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<ul>
  <li>ç¡®ä¿ç³»ç»Ÿä¸ä¼šä» Activity æˆ– Fragment çš„ onResume() æ–¹æ³•è¿›è¡Œå†—ä½™è°ƒç”¨ã€‚</li>
  <li>ç¡®ä¿ Activity æˆ– Fragment å˜ä¸ºæ´»è·ƒçŠ¶æ€åå…·æœ‰å¯ä»¥ç«‹å³æ˜¾ç¤ºçš„æ•°æ®ã€‚ä¸€æ—¦åº”ç”¨ç»„ä»¶å¤„äº STARTED çŠ¶æ€ï¼Œå°±ä¼šä»å®ƒæ­£åœ¨è§‚å¯Ÿçš„ LiveData å¯¹è±¡æ¥æ”¶æœ€æ–°å€¼ã€‚åªæœ‰åœ¨è®¾ç½®äº†è¦è§‚å¯Ÿçš„ LiveData å¯¹è±¡æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚</li>
</ul>

<blockquote>
  <p>é€šå¸¸ï¼ŒLiveData ä»…åœ¨æ•°æ®å‘ç”Ÿæ›´æ”¹æ—¶æ‰å‘é€æ›´æ–°ï¼Œå¹¶ä¸”ä»…å‘é€ç»™æ´»è·ƒè§‚å¯Ÿè€…ã€‚æ­¤è¡Œä¸ºçš„ä¸€ç§ä¾‹å¤–æƒ…å†µæ˜¯ï¼Œè§‚å¯Ÿè€…ä»éæ´»è·ƒçŠ¶æ€æ›´æ”¹ä¸ºæ´»è·ƒçŠ¶æ€æ—¶ä¹Ÿä¼šæ”¶åˆ°æ›´æ–°ã€‚æ­¤å¤–ï¼Œå¦‚æœè§‚å¯Ÿè€…ç¬¬äºŒæ¬¡ä»éæ´»è·ƒçŠ¶æ€æ›´æ”¹ä¸ºæ´»è·ƒçŠ¶æ€ï¼Œåˆ™åªæœ‰åœ¨è‡ªä¸Šæ¬¡å˜ä¸ºæ´»è·ƒçŠ¶æ€ä»¥æ¥å€¼å‘ç”Ÿäº†æ›´æ”¹æ—¶ï¼Œå®ƒæ‰ä¼šæ”¶åˆ°æ›´æ–°ã€‚</p>
</blockquote>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">NameActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">//Use the 'by viewModels()' Kotlin property delegate</span>
    <span class="c1">//from the activity-ktx artifact</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">model</span><span class="p">:</span> <span class="nc">NameViewModel</span> <span class="k">by</span> <span class="nf">viewModels</span><span class="p">()</span>

    <span class="k">private</span> <span class="kd">var</span> <span class="py">i</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="k">private</span> <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">tvText</span><span class="p">:</span> <span class="nc">TextView</span>
    <span class="k">private</span> <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">btn</span><span class="p">:</span> <span class="nc">Button</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="nf">setContentView</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_name</span><span class="p">)</span>
        <span class="n">tvText</span> <span class="p">=</span> <span class="nf">findViewById</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">tvText</span><span class="p">)</span>
        <span class="n">btn</span> <span class="p">=</span> <span class="nf">findViewById</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">btn</span><span class="p">)</span>

        <span class="kd">val</span> <span class="py">nameObserver</span> <span class="p">=</span> <span class="nc">Observer</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">newName</span> <span class="p">-&gt;</span>
            <span class="c1">//update UI</span>
            <span class="n">tvText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">newName</span>

        <span class="p">}</span>

        <span class="c1">//Observe the LiveData, passing in this activity as the LifecycleOwner and the observer.</span>
        <span class="n">model</span><span class="p">.</span><span class="n">currentName</span><span class="p">.</span><span class="nf">observe</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">nameObserver</span><span class="p">)</span>

        <span class="n">btn</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">++</span>
            <span class="n">model</span><span class="p">.</span><span class="n">currentName</span><span class="p">.</span><span class="nf">setValue</span><span class="p">(</span><span class="s">"click $i"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨ä¼ é€’ nameObserver å‚æ•°çš„æƒ…å†µä¸‹è°ƒç”¨ observe() åï¼Œç³»ç»Ÿä¼šç«‹å³è°ƒç”¨ onChanged()ï¼Œä»è€Œæä¾› mCurrentName ä¸­å­˜å‚¨çš„æœ€æ–°å€¼ã€‚å¦‚æœ LiveData å¯¹è±¡å°šæœªåœ¨ mCurrentName ä¸­è®¾ç½®å€¼ï¼Œåˆ™ä¸ä¼šè°ƒç”¨ onChanged()ã€‚</p>

<h3 id="æ›´æ–°-livedata-å¯¹è±¡">æ›´æ–° LiveData å¯¹è±¡</h3>

<p>è®¾ç½®è§‚å¯Ÿè€…å…³ç³»åï¼Œæ‚¨å¯ä»¥æ›´æ–° LiveData å¯¹è±¡çš„å€¼ï¼ˆå¦‚ä»¥ä¸‹ç¤ºä¾‹ä¸­æ‰€ç¤ºï¼‰ï¼Œè¿™æ ·å½“ç”¨æˆ·ç‚¹æŒ‰æŸä¸ªæŒ‰é’®æ—¶ä¼šè§¦å‘æ‰€æœ‰è§‚å¯Ÿè€…ï¼š</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">btn</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>
    <span class="n">i</span><span class="p">++</span>
    <span class="n">model</span><span class="p">.</span><span class="n">currentName</span><span class="p">.</span><span class="nf">setValue</span><span class="p">(</span><span class="s">"click $i"</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨æœ¬ä¾‹ä¸­è°ƒç”¨ setValue(T) å¯¼è‡´è§‚å¯Ÿè€…ä½¿ç”¨å€¼ â€œclick $iâ€ è°ƒç”¨å…¶ onChanged() æ–¹æ³•ã€‚æœ¬ä¾‹ä¸­æ¼”ç¤ºçš„æ˜¯æŒ‰ä¸‹æŒ‰é’®çš„æ–¹æ³•ï¼Œä½†ä¹Ÿå¯ä»¥å‡ºäºå„ç§å„æ ·çš„åŸå› è°ƒç”¨ setValue() æˆ– postValue() æ¥æ›´æ–° mNameï¼Œè¿™äº›åŸå› åŒ…æ‹¬å“åº”ç½‘ç»œè¯·æ±‚æˆ–æ•°æ®åº“åŠ è½½å®Œæˆã€‚åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œè°ƒç”¨ setValue() æˆ– postValue() éƒ½ä¼šè§¦å‘è§‚å¯Ÿè€…å¹¶æ›´æ–°ç•Œé¢ã€‚</p>

<p>æ‚¨å¿…é¡»è°ƒç”¨ setValue(T) æ–¹æ³•ä»¥ä»ä¸»çº¿ç¨‹æ›´æ–° LiveData å¯¹è±¡ã€‚å¦‚æœåœ¨ worker çº¿ç¨‹ä¸­æ‰§è¡Œä»£ç ï¼Œåˆ™æ‚¨å¯ä»¥æ”¹ç”¨ postValue(T) æ–¹æ³•æ¥æ›´æ–° LiveData å¯¹è±¡ã€‚</p>

<h2 id="åŸç†åˆ†æ-1">åŸç†åˆ†æ</h2>

<p>observe()ä½œä¸ºå…¥å£ï¼š</p>

<p>ä½¿ç”¨LifecycleBoundObserveræŠŠè§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…åŒ…è£…åœ¨ä¸€èµ·,ç»‘å®šwrapperä½œä¸ºè§‚å¯Ÿè€…</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="c1">//LiveData.java</span>
<span class="nd">@MainThread</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">observe</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">LifecycleOwner</span> <span class="n">owner</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">Observer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">assertMainThread</span><span class="o">(</span><span class="s">"observe"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">owner</span><span class="o">.</span><span class="na">getLifecycle</span><span class="o">().</span><span class="na">getCurrentState</span><span class="o">()</span> <span class="o">==</span> <span class="no">DESTROYED</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ignore</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">LifecycleBoundObserver</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LifecycleBoundObserver</span><span class="o">(</span><span class="n">owner</span><span class="o">,</span> <span class="n">observer</span><span class="o">);</span>
    <span class="nc">ObserverWrapper</span> <span class="n">existing</span> <span class="o">=</span> <span class="n">mObservers</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">observer</span><span class="o">,</span> <span class="n">wrapper</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">existing</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">existing</span><span class="o">.</span><span class="na">isAttachedTo</span><span class="o">(</span><span class="n">owner</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Cannot add the same observer"</span>
                <span class="o">+</span> <span class="s">" with different lifecycles"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">existing</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">owner</span><span class="o">.</span><span class="na">getLifecycle</span><span class="o">().</span><span class="na">addObserver</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ç»‘å®šå®Œæˆåï¼Œä½¿ç”¨setValueä¸postValueé€šçŸ¥è§‚å¯Ÿè€…,</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre><span class="c1">//LiveData.java</span>
<span class="nd">@MainThread</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setValue</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">assertMainThread</span><span class="o">(</span><span class="s">"setValue"</span><span class="o">);</span>
    <span class="n">mVersion</span><span class="o">++;</span>
    <span class="n">mData</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="n">dispatchingValue</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//å‚æ•°ä¼ nullå’Œä¸ä¼ nullçš„åŒºåˆ«å°±æ˜¯å¦‚æœä¼ nullå°†ä¼šé€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…ï¼Œåä¹‹ä»…ä»…é€šçŸ¥ä¼ å…¥çš„è§‚å¯Ÿè€…ã€‚</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"WeakerAccess"</span><span class="o">)</span> <span class="cm">/* synthetic access */</span>
<span class="kt">void</span> <span class="nf">dispatchingValue</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ObserverWrapper</span> <span class="n">initiator</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mDispatchingValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mDispatchInvalidated</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">mDispatchingValue</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">do</span> <span class="o">{</span>
        <span class="n">mDispatchInvalidated</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">initiator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//åªé€šçŸ¥ä¼ å…¥çš„Observer</span>
            <span class="n">considerNotify</span><span class="o">(</span><span class="n">initiator</span><span class="o">);</span>
            <span class="n">initiator</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">//é€šçŸ¥æ‰€æœ‰Observer</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">Observer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;,</span> <span class="nc">ObserverWrapper</span><span class="o">&gt;&gt;</span> <span class="n">iterator</span> <span class="o">=</span>
                    <span class="n">mObservers</span><span class="o">.</span><span class="na">iteratorWithAdditions</span><span class="o">();</span> <span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">considerNotify</span><span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">().</span><span class="na">getValue</span><span class="o">());</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mDispatchInvalidated</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">mDispatchInvalidated</span><span class="o">);</span>
    <span class="n">mDispatchingValue</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">private</span> <span class="kt">void</span> <span class="nf">considerNotify</span><span class="o">(</span><span class="nc">ObserverWrapper</span> <span class="n">observer</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">observer</span><span class="o">.</span><span class="na">mActive</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.</span>
    <span class="c1">//</span>
    <span class="c1">// we still first check observer.active to keep it as the entrance for events. So even if</span>
    <span class="c1">// the observer moved to an active state, if we've not received that event, we better not</span>
    <span class="c1">// notify for a more predictable notification order.</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">observer</span><span class="o">.</span><span class="na">shouldBeActive</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">observer</span><span class="o">.</span><span class="na">activeStateChanged</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">observer</span><span class="o">.</span><span class="na">mLastVersion</span> <span class="o">&gt;=</span> <span class="n">mVersion</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">observer</span><span class="o">.</span><span class="na">mLastVersion</span> <span class="o">=</span> <span class="n">mVersion</span><span class="o">;</span>
    <span class="c1">//è°ƒç”¨mObserverçš„onChanage()</span>
    <span class="n">observer</span><span class="o">.</span><span class="na">mObserver</span><span class="o">.</span><span class="na">onChanged</span><span class="o">((</span><span class="no">T</span><span class="o">)</span> <span class="n">mData</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="livedatabus">LiveDataBus</h1>

<p>ä¸ºäº†ç®€åŒ–LiveDataæ“ä½œï¼Œå¯ä»¥ä»¿ç…§EventBuså†™ä¸ªLiveDataBus</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">LiveDataBus</span> <span class="kd">private</span> <span class="nf">constructor</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//kotlinçš„ä¸€ç§å•ä¾‹æ¨¡å¼</span>
    <span class="n">companion</span> <span class="n">object</span> <span class="o">{</span>
        <span class="n">val</span> <span class="nl">instance:</span> <span class="nc">LiveDataBus</span> <span class="n">by</span> <span class="nf">lazy</span><span class="o">(</span><span class="n">mode</span> <span class="o">=</span> <span class="nc">LazyThreadSafetyMode</span><span class="o">.</span><span class="na">SYNCHRONIZED</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">LiveDataBus</span><span class="o">()</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//å­˜æ”¾è®¢é˜…è€…</span>
    <span class="kd">private</span> <span class="n">val</span> <span class="nl">bus:</span> <span class="nc">MutableMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">MutableLiveData</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="n">mutableMapOf</span><span class="o">()</span>
    <span class="c1">//æ³¨å†Œè®¢é˜…è€…</span>
    <span class="nd">@Synchronized</span>
    <span class="n">fun</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">with</span><span class="o">(</span><span class="nl">key:</span> <span class="nc">String</span><span class="o">,</span> <span class="nl">type:</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;):</span> <span class="nc">MutableLiveData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">bus</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">bus</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="nc">MutableLiveData</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nd">@Suppress</span><span class="o">(</span><span class="s">"UNCHECKED_CAST"</span><span class="o">)</span>
        <span class="k">return</span> <span class="n">bus</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="n">as</span> <span class="nc">MutableLiveData</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½¿ç”¨:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>
<span class="c1">//MainActivity.java</span>

<span class="nc">Thread</span> <span class="p">{</span>
    <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">10</span><span class="p">).</span><span class="nf">forEach</span> <span class="p">{</span>
        <span class="c1">//å‘é€</span>
        <span class="nc">LiveDataBus</span><span class="p">.</span><span class="n">instance</span>
            <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="s">"data"</span><span class="p">,</span> <span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">).</span><span class="nf">postValue</span><span class="p">(</span><span class="s">"hello $it"</span><span class="p">)</span>
        <span class="nc">SystemClock</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}.</span><span class="nf">start</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>è®¢é˜…:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">LiveDataBusTestActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="nf">setContentView</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_livedata_bus</span><span class="p">)</span>
        <span class="c1">//è®¢é˜…</span>
        <span class="nc">LiveDataBus</span><span class="p">.</span><span class="n">instance</span>
            <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="s">"data"</span><span class="p">,</span> <span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">).</span><span class="nf">observe</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span>
                <span class="nc">Toast</span><span class="p">.</span><span class="nf">makeText</span><span class="p">(</span><span class="n">baseContext</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="nc">Toast</span><span class="p">.</span><span class="nc">LENGTH_SHORT</span><span class="p">).</span><span class="nf">show</span><span class="p">()</span>
            <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
:ET